{
  "version": 3,
  "sources": ["../../../src/utils/logger.ts", "../../../src/utils/error-handler.ts", "../../../src/api/health.ts", "../../../src/utils/retry.ts", "../../../src/ingestion/cache.ts", "../../../src/api/cache-proxy.ts", "../../../src/search/ai-search-client.ts", "../../../src/search/result-enricher.ts", "../../../src/utils/metrics.ts", "../../../src/api/search-endpoint.ts", "../../../src/api/mcp-handler.ts", "../../../static/openapi.json", "../../../src/index.ts", "../../../node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts", "../../../node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts", "../bundle-NTKv1p/middleware-insertion-facade.js", "../../../node_modules/wrangler/templates/middleware/common.ts", "../bundle-NTKv1p/middleware-loader.entry.ts"],
  "sourceRoot": "/Users/cns/httpdocs/cddo/govreposcrape/.wrangler/tmp/dev-Hkomlt",
  "sourcesContent": ["/**\n * Structured JSON logger for Cloudflare Workers\n * Outputs JSON-formatted logs compatible with Cloudflare Workers log streaming\n *\n * @example\n * ```typescript\n * const logger = createLogger({ operation: 'fetchRepos' });\n * logger.info('Fetching repositories', { count: 100 });\n * // Output: {\"timestamp\":\"2025-11-12T10:00:00.000Z\",\"level\":\"info\",\"message\":\"Fetching repositories\",\"context\":{\"operation\":\"fetchRepos\",\"metadata\":{\"count\":100}}}\n * ```\n */\n\n/**\n * Log levels in order of severity\n */\nexport type LogLevel = \"debug\" | \"info\" | \"warn\" | \"error\";\n\n/**\n * Log level priority mapping (lower number = higher priority)\n */\nconst LOG_LEVEL_PRIORITY: Record<LogLevel, number> = {\n\tdebug: 0,\n\tinfo: 1,\n\twarn: 2,\n\terror: 3,\n};\n\n/**\n * Log context attached to every log entry\n */\nexport interface LogContext {\n\t/** Optional UUID v4 for request tracing across distributed services */\n\trequestId?: string;\n\t/** Required string identifying the function/module/operation */\n\toperation: string;\n\t/** Optional key-value pairs for additional context */\n\tmetadata?: Record<string, unknown>;\n}\n\n/**\n * Structure of JSON log output\n */\nexport interface LogEntry {\n\t/** ISO 8601 timestamp */\n\ttimestamp: string;\n\t/** Log severity level */\n\tlevel: LogLevel;\n\t/** Human-readable log message */\n\tmessage: string;\n\t/** Context information */\n\tcontext: LogContext;\n}\n\n/**\n * Logger instance with bound context\n */\nexport interface Logger {\n\t/**\n\t * Log debug-level message (development only)\n\t * @param message - Log message\n\t * @param metadata - Optional additional context\n\t */\n\tdebug(message: string, metadata?: Record<string, unknown>): void;\n\n\t/**\n\t * Log info-level message (general information)\n\t * @param message - Log message\n\t * @param metadata - Optional additional context\n\t */\n\tinfo(message: string, metadata?: Record<string, unknown>): void;\n\n\t/**\n\t * Log warning-level message (potential issues)\n\t * @param message - Log message\n\t * @param metadata - Optional additional context\n\t */\n\twarn(message: string, metadata?: Record<string, unknown>): void;\n\n\t/**\n\t * Log error-level message (failures)\n\t * @param message - Log message\n\t * @param metadata - Optional additional context\n\t */\n\terror(message: string, metadata?: Record<string, unknown>): void;\n}\n\n/**\n * Create a logger instance with bound base context\n *\n * The logger outputs structured JSON logs to console.log, which are automatically\n * captured by Cloudflare Workers log streaming.\n *\n * @param baseContext - Base context merged with per-call metadata\n * @param minLogLevel - Minimum log level to output (default: \"debug\"). Logs below this level are filtered.\n * @returns Logger instance with debug, info, warn, error methods\n *\n * @example\n * ```typescript\n * const logger = createLogger({ operation: 'ingestRepo', requestId: 'req-123' }, 'info');\n * logger.debug('Debugging info'); // Filtered out if minLogLevel is 'info'\n * logger.info('Processing repository', { repo: 'alphagov/govuk-frontend' }); // Logged\n * ```\n */\nexport function createLogger(\n\tbaseContext: Partial<LogContext>,\n\tminLogLevel: LogLevel = \"debug\",\n): Logger {\n\tconst minPriority = LOG_LEVEL_PRIORITY[minLogLevel];\n\n\t/**\n\t * Create a log entry and output it as JSON\n\t */\n\tfunction log(\n\t\tlevel: LogEntry[\"level\"],\n\t\tmessage: string,\n\t\tmetadata?: Record<string, unknown>,\n\t): void {\n\t\t// Filter logs below the minimum log level\n\t\tif (LOG_LEVEL_PRIORITY[level] < minPriority) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst entry: LogEntry = {\n\t\t\ttimestamp: new Date().toISOString(),\n\t\t\tlevel,\n\t\t\tmessage,\n\t\t\tcontext: {\n\t\t\t\toperation: baseContext.operation || \"unknown\",\n\t\t\t\t...(baseContext.requestId && { requestId: baseContext.requestId }),\n\t\t\t\t...(metadata && { metadata }),\n\t\t\t},\n\t\t};\n\n\t\t// Output as JSON to console.log (Cloudflare Workers compatible)\n\t\tconsole.log(JSON.stringify(entry));\n\t}\n\n\treturn {\n\t\tdebug: (message: string, metadata?: Record<string, unknown>) => log(\"debug\", message, metadata),\n\t\tinfo: (message: string, metadata?: Record<string, unknown>) => log(\"info\", message, metadata),\n\t\twarn: (message: string, metadata?: Record<string, unknown>) => log(\"warn\", message, metadata),\n\t\terror: (message: string, metadata?: Record<string, unknown>) => log(\"error\", message, metadata),\n\t};\n}\n", "/**\n * Custom error classes for govreposcrape\n * Provides structured error handling with HTTP status codes and formatted responses\n *\n * All error classes follow the PRD FR-3 specification:\n * ErrorResponse format: { error: { code: string, message: string, retry_after?: number } }\n *\n * @example\n * ```typescript\n * throw new ValidationError('Query too short', 'INVALID_QUERY');\n * throw new ServiceError('AI Search unavailable', 503, 'SEARCH_UNAVAILABLE', 60);\n * throw new APIError('External API failed', 502, 'EXTERNAL_API_ERROR');\n * ```\n */\n\nimport type { ErrorResponse } from \"../types\";\n\n/**\n * Base application error class\n * Extends Error with statusCode and code properties\n */\nexport class AppError extends Error {\n\t/** HTTP status code for this error */\n\tstatusCode: number;\n\t/** Machine-readable error code */\n\tcode: string;\n\n\tconstructor(message: string, statusCode: number, code: string) {\n\t\tsuper(message);\n\t\tthis.name = \"AppError\";\n\t\tthis.statusCode = statusCode;\n\t\tthis.code = code;\n\t}\n\n\t/**\n\t * Convert error to PRD FR-3 compliant ErrorResponse format\n\t * @returns Formatted error response object\n\t */\n\ttoErrorResponse(): ErrorResponse {\n\t\treturn {\n\t\t\terror: {\n\t\t\t\tcode: this.code,\n\t\t\t\tmessage: this.message,\n\t\t\t},\n\t\t};\n\t}\n}\n\n/**\n * Validation error for invalid input or malformed requests\n * Always returns HTTP 400 status code\n *\n * Use cases:\n * - Invalid query parameters\n * - Malformed request bodies\n * - Missing required fields\n * - Input validation failures\n *\n * @example\n * ```typescript\n * if (query.length < 3) {\n *   throw new ValidationError(\n *     'Query must be at least 3 characters',\n *     'QUERY_TOO_SHORT'\n *   );\n * }\n * ```\n */\nexport class ValidationError extends AppError {\n\tconstructor(message: string, code = \"VALIDATION_ERROR\") {\n\t\tsuper(message, 400, code);\n\t\tthis.name = \"ValidationError\";\n\t}\n}\n\n/**\n * Service error for internal service failures or dependency unavailability\n * Supports both 500 (internal error) and 503 (service unavailable) status codes\n *\n * Use cases:\n * - Internal service failures\n * - Database unavailability\n * - External dependency failures\n * - Temporary service outages\n *\n * @example\n * ```typescript\n * throw new ServiceError(\n *   'AI Search temporarily unavailable',\n *   503,\n *   'SEARCH_UNAVAILABLE',\n *   60  // retry after 60 seconds\n * );\n * ```\n */\nexport class ServiceError extends AppError {\n\t/** Optional: seconds to wait before retrying */\n\tretryAfter?: number;\n\n\tconstructor(message: string, statusCode = 500, code = \"SERVICE_ERROR\", retryAfter?: number) {\n\t\tsuper(message, statusCode, code);\n\t\tthis.name = \"ServiceError\";\n\t\tthis.retryAfter = retryAfter;\n\t}\n\n\t/**\n\t * Convert error to PRD FR-3 compliant ErrorResponse format\n\t * Includes retry_after field if specified\n\t * @returns Formatted error response object\n\t */\n\ttoErrorResponse(): ErrorResponse {\n\t\tconst response: ErrorResponse = {\n\t\t\terror: {\n\t\t\t\tcode: this.code,\n\t\t\t\tmessage: this.message,\n\t\t\t},\n\t\t};\n\n\t\tif (this.retryAfter !== undefined) {\n\t\t\tresponse.error.retry_after = this.retryAfter;\n\t\t}\n\n\t\treturn response;\n\t}\n}\n\n/**\n * Generic API error with custom HTTP status code\n * Used for specific HTTP error scenarios not covered by other error classes\n *\n * Use cases:\n * - External API failures (502 Bad Gateway)\n * - Rate limiting (429 Too Many Requests)\n * - Custom HTTP status codes\n * - Proxy errors\n *\n * @example\n * ```typescript\n * throw new APIError(\n *   'External API rate limit exceeded',\n *   429,\n *   'RATE_LIMIT_EXCEEDED'\n * );\n * ```\n */\nexport class APIError extends AppError {\n\tconstructor(message: string, statusCode: number, code: string) {\n\t\tsuper(message, statusCode, code);\n\t\tthis.name = \"APIError\";\n\t}\n}\n", "/**\n * Health check endpoint for govreposcrape\n * Validates connectivity to all Cloudflare service bindings\n *\n * Returns 200 OK when all services are accessible\n * Returns 503 Service Unavailable when any service fails\n *\n * @example\n * ```typescript\n * // GET /health\n * // Response: { \"status\": \"healthy\", \"services\": {...}, \"timestamp\": \"2025-11-12T10:00:00.000Z\" }\n * ```\n */\n\nimport { createLogger } from \"../utils/logger\";\nimport { ServiceError } from \"../utils/error-handler\";\nimport type { ErrorResponse } from \"../types\";\n\nconst logger = createLogger({ operation: \"healthCheck\" });\n\n/**\n * Service status result\n */\nexport interface ServiceStatus {\n\t/** Service name */\n\tname: string;\n\t/** Connection status: \"ok\" or \"failed\" */\n\tstatus: \"ok\" | \"failed\";\n\t/** Optional error message if failed */\n\terror?: string;\n}\n\n/**\n * Health check response format\n */\nexport interface HealthCheckResponse {\n\t/** Overall health status: \"healthy\" or \"unhealthy\" */\n\tstatus: \"healthy\" | \"unhealthy\";\n\t/** Individual service statuses */\n\tservices: Record<string, ServiceStatus>;\n\t/** ISO 8601 timestamp */\n\ttimestamp: string;\n}\n\n/**\n * Check health of all service bindings\n *\n * Validates connectivity to:\n * - KV namespace (test read operation)\n * - R2 bucket (test list operation)\n * - Vectorize index (test metadata query)\n * - D1 database (test query execution)\n * - AI Search (test query execution) - Epic 3 Story 3.1\n *\n * @param env - Cloudflare Workers environment with service bindings\n * @param requestId - Optional request correlation ID\n * @returns Response with 200 OK or 503 Service Unavailable\n */\nexport async function checkHealth(env: Env, requestId?: string): Promise<Response> {\n\tconst timestamp = new Date().toISOString();\n\tconst services: Record<string, ServiceStatus> = {};\n\tlet allHealthy = true;\n\n\tlogger.info(\"Starting health check\", {\n\t\trequestId,\n\t\ttimestamp,\n\t});\n\n\t// Check KV namespace\n\ttry {\n\t\t// Test read operation (key won't exist, but validates connectivity)\n\t\tawait env.KV.get(\"health-check-test\");\n\t\tservices.kv = {\n\t\t\tname: \"KV Namespace\",\n\t\t\tstatus: \"ok\",\n\t\t};\n\t\tlogger.debug(\"KV health check passed\", { requestId });\n\t} catch (error) {\n\t\tallHealthy = false;\n\t\tconst errorMessage = error instanceof Error ? error.message : String(error);\n\t\tservices.kv = {\n\t\t\tname: \"KV Namespace\",\n\t\t\tstatus: \"failed\",\n\t\t\terror: errorMessage,\n\t\t};\n\t\tlogger.error(\"KV health check failed\", {\n\t\t\trequestId,\n\t\t\terror: errorMessage,\n\t\t});\n\t}\n\n\t// Check R2 bucket\n\ttry {\n\t\t// Test list operation (validates bucket access)\n\t\tawait env.R2.list({ limit: 1 });\n\t\tservices.r2 = {\n\t\t\tname: \"R2 Bucket\",\n\t\t\tstatus: \"ok\",\n\t\t};\n\t\tlogger.debug(\"R2 health check passed\", { requestId });\n\t} catch (error) {\n\t\tallHealthy = false;\n\t\tconst errorMessage = error instanceof Error ? error.message : String(error);\n\t\tservices.r2 = {\n\t\t\tname: \"R2 Bucket\",\n\t\t\tstatus: \"failed\",\n\t\t\terror: errorMessage,\n\t\t};\n\t\tlogger.error(\"R2 health check failed\", {\n\t\t\trequestId,\n\t\t\terror: errorMessage,\n\t\t});\n\t}\n\n\t// Check Vectorize index\n\ttry {\n\t\t// Test metadata query (validates index access without inserting data)\n\t\t// Note: Vectorize might not have a direct metadata query, so we use a minimal operation\n\t\t// For now, we'll check if the binding exists\n\t\tif (env.VECTORIZE) {\n\t\t\tservices.vectorize = {\n\t\t\t\tname: \"Vectorize Index\",\n\t\t\t\tstatus: \"ok\",\n\t\t\t};\n\t\t\tlogger.debug(\"Vectorize health check passed\", { requestId });\n\t\t} else {\n\t\t\tthrow new Error(\"Vectorize binding not available\");\n\t\t}\n\t} catch (error) {\n\t\tallHealthy = false;\n\t\tconst errorMessage = error instanceof Error ? error.message : String(error);\n\t\tservices.vectorize = {\n\t\t\tname: \"Vectorize Index\",\n\t\t\tstatus: \"failed\",\n\t\t\terror: errorMessage,\n\t\t};\n\t\tlogger.error(\"Vectorize health check failed\", {\n\t\t\trequestId,\n\t\t\terror: errorMessage,\n\t\t});\n\t}\n\n\t// Check D1 database\n\ttry {\n\t\t// Test query execution (validates database connection)\n\t\tawait env.DB.prepare(\"SELECT 1\").first();\n\t\tservices.d1 = {\n\t\t\tname: \"D1 Database\",\n\t\t\tstatus: \"ok\",\n\t\t};\n\t\tlogger.debug(\"D1 health check passed\", { requestId });\n\t} catch (error) {\n\t\tallHealthy = false;\n\t\tconst errorMessage = error instanceof Error ? error.message : String(error);\n\t\tservices.d1 = {\n\t\t\tname: \"D1 Database\",\n\t\t\tstatus: \"failed\",\n\t\t\terror: errorMessage,\n\t\t};\n\t\tlogger.error(\"D1 health check failed\", {\n\t\t\trequestId,\n\t\t\terror: errorMessage,\n\t\t});\n\t}\n\n\t// Check AI Search (Epic 3 Story 3.1)\n\ttry {\n\t\t// Test minimal query to validate AI Search binding is accessible\n\t\t// Using max_num_results=1 to minimize latency and resource usage\n\t\t// API usage: env.AI.autorag(\"govreposcrape-search\").search({ query, ... })\n\t\tawait env.AI.autorag(\"govreposcrape-search\").search({\n\t\t\tquery: \"test\",\n\t\t\tmax_num_results: 1,\n\t\t});\n\t\tservices.ai_search = {\n\t\t\tname: \"AI Search\",\n\t\t\tstatus: \"ok\",\n\t\t};\n\t\tlogger.debug(\"AI Search health check passed\", { requestId });\n\t} catch (error) {\n\t\tallHealthy = false;\n\t\tconst errorMessage = error instanceof Error ? error.message : String(error);\n\t\tservices.ai_search = {\n\t\t\tname: \"AI Search\",\n\t\t\tstatus: \"failed\",\n\t\t\terror: errorMessage,\n\t\t};\n\t\tlogger.error(\"AI Search health check failed\", {\n\t\t\trequestId,\n\t\t\terror: errorMessage,\n\t\t});\n\t}\n\n\tconst response: HealthCheckResponse = {\n\t\tstatus: allHealthy ? \"healthy\" : \"unhealthy\",\n\t\tservices,\n\t\ttimestamp,\n\t};\n\n\tif (allHealthy) {\n\t\tlogger.info(\"Health check completed: all services healthy\", {\n\t\t\trequestId,\n\t\t\tservices: Object.keys(services),\n\t\t});\n\t\treturn new Response(JSON.stringify(response), {\n\t\t\tstatus: 200,\n\t\t\theaders: {\n\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t},\n\t\t});\n\t} else {\n\t\tlogger.warn(\"Health check completed: some services unhealthy\", {\n\t\t\trequestId,\n\t\t\tfailedServices: Object.entries(services)\n\t\t\t\t.filter(([_, s]) => s.status === \"failed\")\n\t\t\t\t.map(([name]) => name),\n\t\t});\n\n\t\t// Use ServiceError for 503 response\n\t\tconst error = new ServiceError(\n\t\t\t\"One or more services are unavailable\",\n\t\t\t503,\n\t\t\t\"SERVICE_UNAVAILABLE\",\n\t\t);\n\n\t\tconst errorResponse: ErrorResponse = error.toErrorResponse();\n\n\t\t// Include service details in response for debugging\n\t\tconst detailedResponse = {\n\t\t\t...errorResponse,\n\t\t\tdetails: response,\n\t\t};\n\n\t\treturn new Response(JSON.stringify(detailedResponse), {\n\t\t\tstatus: 503,\n\t\t\theaders: {\n\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t},\n\t\t});\n\t}\n}\n", "/**\n * Retry utility with exponential backoff\n * Implements architecture.md retry pattern: 3 attempts with delays [1s, 2s, 4s]\n *\n * Use cases:\n * - repos.json fetch failures\n * - gitingest container processing errors\n * - R2 upload failures\n * - AI Search query timeouts\n *\n * @example\n * ```typescript\n * const data = await withRetry(\n *   () => fetch('https://example.com/repos.json').then(r => r.json()),\n *   3,\n *   [1000, 2000, 4000]\n * );\n * ```\n */\n\nimport { createLogger } from \"./logger\";\n\nconst logger = createLogger({ operation: \"retry\" });\n\n/**\n * Execute a function with retry logic and exponential backoff\n *\n * Retries the provided function up to maxRetries times, waiting progressively\n * longer between attempts. Throws the last error if all retries are exhausted.\n *\n * @template T - Return type of the function\n * @param fn - Async function to execute with retry logic\n * @param maxRetries - Maximum number of retry attempts (default: 3)\n * @param delays - Array of delay durations in milliseconds for each retry (default: [1000, 2000, 4000])\n * @returns Promise resolving to the function's return value\n * @throws The last error if all retries are exhausted\n *\n * @example\n * ```typescript\n * // Retry fetch with default settings (3 attempts, 1s/2s/4s delays)\n * const response = await withRetry(() => fetch('/api/data'));\n *\n * // Custom retry configuration\n * const result = await withRetry(\n *   () => processRepository(repo),\n *   5,  // 5 attempts\n *   [500, 1000, 2000, 4000, 8000]  // custom delays\n * );\n * ```\n */\nexport async function withRetry<T>(\n\tfn: () => Promise<T>,\n\tmaxRetries = 3,\n\tdelays = [1000, 2000, 4000],\n): Promise<T> {\n\tlet lastError: Error | unknown;\n\tlet attempt = 0;\n\n\twhile (attempt < maxRetries) {\n\t\ttry {\n\t\t\t// Attempt to execute the function\n\t\t\tconst result = await fn();\n\n\t\t\t// Log successful retry if this wasn't the first attempt\n\t\t\tif (attempt > 0) {\n\t\t\t\tlogger.info(\"Retry succeeded\", {\n\t\t\t\t\tattempt: attempt + 1,\n\t\t\t\t\ttotalAttempts: maxRetries,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn result;\n\t\t} catch (error) {\n\t\t\tlastError = error;\n\t\t\tattempt++;\n\n\t\t\t// If we've exhausted all retries, throw the last error\n\t\t\tif (attempt >= maxRetries) {\n\t\t\t\tlogger.error(\"All retry attempts exhausted\", {\n\t\t\t\t\tattempts: maxRetries,\n\t\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t\t});\n\t\t\t\tthrow lastError;\n\t\t\t}\n\n\t\t\t// Calculate delay for this retry attempt (use array index, fallback to last delay)\n\t\t\tconst delay = delays[attempt - 1] ?? delays[delays.length - 1];\n\n\t\t\t// Log retry attempt\n\t\t\tlogger.warn(\"Retry attempt failed, will retry\", {\n\t\t\t\tattempt: attempt,\n\t\t\t\tmaxRetries,\n\t\t\t\tnextDelayMs: delay,\n\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t});\n\n\t\t\t// Wait before next attempt\n\t\t\tawait sleep(delay);\n\t\t}\n\t}\n\n\t// This should never be reached, but TypeScript requires it\n\tthrow lastError;\n}\n\n/**\n * Sleep for specified milliseconds\n * @param ms - Milliseconds to sleep\n * @returns Promise that resolves after the delay\n */\nfunction sleep(ms: number): Promise<void> {\n\treturn new Promise((resolve) => setTimeout(resolve, ms));\n}\n", "/**\n * Smart Caching Module - Story 2.2\n * Implements KV-based caching to achieve 90%+ cache hit rate\n *\n * Strategy: Only reprocess repositories when pushedAt timestamp changes\n * Performance: Low latency KV reads (<10ms), eventually consistent writes (1-60s)\n * Error Handling: Cache read failures treated as miss (fail-safe), write failures retried\n */\n\nimport type { RepoMetadata, CacheEntry, CacheCheckResult, CacheStats } from \"../types\";\nimport { createLogger } from \"../utils/logger\";\nimport { withRetry } from \"../utils/retry\";\n\nconst logger = createLogger({ operation: \"cache\" });\n\n/**\n * In-memory cache statistics for the current run\n * Reset on Worker restart\n */\nlet cacheStats: CacheStats = {\n\ttotalChecks: 0,\n\thits: 0,\n\tmisses: 0,\n\thitRate: 0,\n};\n\n/**\n * Generate KV cache key from repository metadata\n * Pattern: `repo:{org}/{name}`\n *\n * @param org - GitHub organization name\n * @param name - Repository name\n * @returns KV cache key\n *\n * @example\n * ```typescript\n * const key = getCacheKey(\"alphagov\", \"govuk-frontend\");\n * // Returns: \"repo:alphagov/govuk-frontend\"\n * ```\n */\nexport function getCacheKey(org: string, name: string): string {\n\treturn `repo:${org}/${name}`;\n}\n\n/**\n * Check if repository needs processing by comparing pushedAt timestamps\n * Queries KV for cached entry and compares timestamps\n *\n * Cache Decision Logic:\n * - No cache entry \u2192 needs processing (cache miss)\n * - pushedAt matches \u2192 skip processing (cache hit)\n * - pushedAt differs \u2192 needs processing (stale cache)\n * - KV read error \u2192 needs processing (fail-safe)\n *\n * @param repo - Repository metadata from repos.json\n * @param kv - KV namespace binding\n * @returns Cache check result with needsProcessing flag and reason\n *\n * @example\n * ```typescript\n * const result = await checkCache(repo, env.CACHE_KV);\n * if (!result.needsProcessing) {\n *   logger.info(\"Skipping cached repository\", { repo: repo.name });\n * }\n * ```\n */\nexport async function checkCache(repo: RepoMetadata, kv: KVNamespace): Promise<CacheCheckResult> {\n\tconst key = getCacheKey(repo.org, repo.name);\n\tcacheStats.totalChecks++;\n\n\ttry {\n\t\tlogger.debug(\"Checking cache\", {\n\t\t\trepo: `${repo.org}/${repo.name}`,\n\t\t\tkey,\n\t\t});\n\n\t\tconst cached = await kv.get<CacheEntry>(key, \"json\");\n\n\t\tif (!cached) {\n\t\t\tcacheStats.misses++;\n\t\t\tlogger.info(\"Cache miss - no entry\", {\n\t\t\t\trepo: `${repo.org}/${repo.name}`,\n\t\t\t});\n\t\t\treturn {\n\t\t\t\tneedsProcessing: true,\n\t\t\t\treason: \"cache-miss\",\n\t\t\t};\n\t\t}\n\n\t\t// Validate cache entry structure\n\t\tif (!cached.pushedAt || !cached.processedAt || !cached.status) {\n\t\t\tcacheStats.misses++;\n\t\t\tlogger.warn(\"Cache miss - malformed entry\", {\n\t\t\t\trepo: `${repo.org}/${repo.name}`,\n\t\t\t\tcached,\n\t\t\t});\n\t\t\treturn {\n\t\t\t\tneedsProcessing: true,\n\t\t\t\treason: \"cache-miss\",\n\t\t\t};\n\t\t}\n\n\t\tif (cached.pushedAt === repo.pushedAt) {\n\t\t\tcacheStats.hits++;\n\t\t\tlogger.info(\"Cache hit\", {\n\t\t\t\trepo: `${repo.org}/${repo.name}`,\n\t\t\t\tcachedPushedAt: cached.pushedAt,\n\t\t\t});\n\t\t\treturn {\n\t\t\t\tneedsProcessing: false,\n\t\t\t\treason: \"cache-hit\",\n\t\t\t\tcachedEntry: cached,\n\t\t\t};\n\t\t}\n\n\t\tcacheStats.misses++;\n\t\tlogger.info(\"Cache stale - pushedAt changed\", {\n\t\t\trepo: `${repo.org}/${repo.name}`,\n\t\t\tcachedPushedAt: cached.pushedAt,\n\t\t\tcurrentPushedAt: repo.pushedAt,\n\t\t});\n\t\treturn {\n\t\t\tneedsProcessing: true,\n\t\t\treason: \"stale-cache\",\n\t\t\tcachedEntry: cached,\n\t\t};\n\t} catch (error) {\n\t\t// Treat KV read errors as cache miss (fail-safe)\n\t\tcacheStats.misses++;\n\t\tlogger.error(\"Cache check failed - treating as miss\", {\n\t\t\trepo: `${repo.org}/${repo.name}`,\n\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t});\n\t\treturn {\n\t\t\tneedsProcessing: true,\n\t\t\treason: \"cache-miss\",\n\t\t};\n\t}\n}\n\n/**\n * Update cache after successful repository processing\n * Writes cache entry to KV with retry logic for resilience\n *\n * Cache Entry Structure:\n * - pushedAt: Timestamp from repos.json\n * - processedAt: Current timestamp\n * - status: \"complete\"\n *\n * @param repo - Repository metadata from repos.json\n * @param kv - KV namespace binding\n * @returns Promise that resolves when cache is updated\n *\n * @example\n * ```typescript\n * await processRepository(repo);\n * await updateCache(repo, env.CACHE_KV);\n * logger.info(\"Repository processed and cached\", { repo: repo.name });\n * ```\n */\nexport async function updateCache(repo: RepoMetadata, kv: KVNamespace): Promise<void> {\n\tconst key = getCacheKey(repo.org, repo.name);\n\n\tconst entry: CacheEntry = {\n\t\tpushedAt: repo.pushedAt,\n\t\tprocessedAt: new Date().toISOString(),\n\t\tstatus: \"complete\",\n\t};\n\n\ttry {\n\t\tawait withRetry(\n\t\t\tasync () => {\n\t\t\t\tawait kv.put(key, JSON.stringify(entry));\n\t\t\t},\n\t\t\t3,\n\t\t\t[1000, 2000, 4000],\n\t\t);\n\n\t\tlogger.info(\"Cache updated\", {\n\t\t\trepo: `${repo.org}/${repo.name}`,\n\t\t\tpushedAt: repo.pushedAt,\n\t\t});\n\t} catch (error) {\n\t\t// Log error but don't throw - cache write failure shouldn't block processing\n\t\tlogger.error(\"Cache update failed after retries\", {\n\t\t\trepo: `${repo.org}/${repo.name}`,\n\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t});\n\t}\n}\n\n/**\n * Get current cache performance statistics\n * Calculates hit rate percentage: (hits / totalChecks) * 100\n *\n * Statistics tracked in-memory per Worker instance:\n * - totalChecks: Total cache check operations\n * - hits: Successful cache hits (no reprocessing needed)\n * - misses: Cache misses + stale cache (reprocessing needed)\n * - hitRate: Percentage of hits (target: 90%+)\n *\n * @returns Current cache statistics\n *\n * @example\n * ```typescript\n * const stats = getCacheStats();\n * logger.info(\"Cache performance\", {\n *   hitRate: `${stats.hitRate.toFixed(1)}%`,\n *   checks: stats.totalChecks,\n * });\n * ```\n */\nexport function getCacheStats(): CacheStats {\n\tconst hitRate = cacheStats.totalChecks > 0 ? (cacheStats.hits / cacheStats.totalChecks) * 100 : 0;\n\n\treturn {\n\t\t...cacheStats,\n\t\thitRate,\n\t};\n}\n\n/**\n * Reset cache statistics\n * Useful for testing and periodic statistics reporting\n *\n * @example\n * ```typescript\n * resetCacheStats();\n * // Process batch of repositories\n * const stats = getCacheStats();\n * logger.info(\"Batch cache performance\", stats);\n * ```\n */\nexport function resetCacheStats(): void {\n\tcacheStats = {\n\t\ttotalChecks: 0,\n\t\thits: 0,\n\t\tmisses: 0,\n\t\thitRate: 0,\n\t};\n\tlogger.debug(\"Cache statistics reset\");\n}\n", "/**\n * Cache Proxy API - Quality Story 1 Fix\n * Provides HTTP endpoints for Docker containers to access Workers KV namespace\n *\n * Architecture: Docker Container \u2192 HTTP \u2192 Worker KV Proxy \u2192 KV Namespace\n *\n * Endpoints:\n * - GET /cache/:org/:repo - Check if repository is cached\n * - PUT /cache/:org/:repo - Update cache after processing\n * - GET /cache/stats - Get cache statistics\n */\n\nimport type { CacheEntry } from \"../types\";\nimport { createLogger } from \"../utils/logger\";\nimport { checkCache, updateCache, getCacheStats } from \"../ingestion/cache\";\n\nconst logger = createLogger({ operation: \"cache-proxy\" });\n\n/**\n * Parse org and repo from URL path\n * Expected format: /cache/:org/:repo\n *\n * @param pathname - URL pathname\n * @returns Object with org and repo, or null if invalid\n */\nfunction parseOrgRepo(pathname: string): { org: string; repo: string } | null {\n\tconst match = pathname.match(/^\\/cache\\/([^/]+)\\/([^/]+)$/);\n\tif (!match) {\n\t\treturn null;\n\t}\n\n\treturn {\n\t\torg: decodeURIComponent(match[1]),\n\t\trepo: decodeURIComponent(match[2]),\n\t};\n}\n\n/**\n * GET /cache/:org/:repo\n * Check if repository exists in cache\n *\n * Response:\n * - 200: Cache entry found { pushedAt, processedAt, status }\n * - 404: Not in cache or stale\n * - 400: Invalid parameters\n * - 500: Server error\n */\nexport async function getCacheEntry(url: URL, env: Env, requestId: string): Promise<Response> {\n\tconst parsed = parseOrgRepo(url.pathname);\n\n\tif (!parsed) {\n\t\tlogger.warn(\"Invalid cache GET request\", {\n\t\t\trequestId,\n\t\t\tpath: url.pathname,\n\t\t});\n\t\treturn new Response(\n\t\t\tJSON.stringify({\n\t\t\t\terror: {\n\t\t\t\t\tcode: \"INVALID_PATH\",\n\t\t\t\t\tmessage: \"Expected format: /cache/:org/:repo\",\n\t\t\t\t},\n\t\t\t}),\n\t\t\t{\n\t\t\t\tstatus: 400,\n\t\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t\t},\n\t\t);\n\t}\n\n\tconst { org, repo } = parsed;\n\n\ttry {\n\t\t// Check pushedAt from query parameter (required for cache comparison)\n\t\tconst pushedAt = url.searchParams.get(\"pushedAt\");\n\t\tif (!pushedAt) {\n\t\t\treturn new Response(\n\t\t\t\tJSON.stringify({\n\t\t\t\t\terror: {\n\t\t\t\t\t\tcode: \"MISSING_PUSHED_AT\",\n\t\t\t\t\t\tmessage: \"Query parameter 'pushedAt' is required\",\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t\t{\n\t\t\t\t\tstatus: 400,\n\t\t\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t\t\t},\n\t\t\t);\n\t\t}\n\n\t\t// Use existing cache checking logic\n\t\tconst result = await checkCache(\n\t\t\t{ org, name: repo, pushedAt, url: `https://github.com/${org}/${repo}` },\n\t\t\tenv.KV,\n\t\t);\n\n\t\tif (result.needsProcessing) {\n\t\t\t// Cache miss or stale - return 404\n\t\t\tlogger.info(\"Cache proxy: miss/stale\", {\n\t\t\t\trequestId,\n\t\t\t\torg,\n\t\t\t\trepo,\n\t\t\t\treason: result.reason,\n\t\t\t});\n\n\t\t\treturn new Response(\n\t\t\t\tJSON.stringify({\n\t\t\t\t\tneedsProcessing: true,\n\t\t\t\t\treason: result.reason,\n\t\t\t\t}),\n\t\t\t\t{\n\t\t\t\t\tstatus: 404,\n\t\t\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t\t\t},\n\t\t\t);\n\t\t}\n\n\t\t// Cache hit - return entry\n\t\tlogger.info(\"Cache proxy: hit\", {\n\t\t\trequestId,\n\t\t\torg,\n\t\t\trepo,\n\t\t});\n\n\t\treturn new Response(JSON.stringify(result.cachedEntry), {\n\t\t\tstatus: 200,\n\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t});\n\t} catch (error) {\n\t\tlogger.error(\"Cache GET failed\", {\n\t\t\trequestId,\n\t\t\torg,\n\t\t\trepo,\n\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t});\n\n\t\treturn new Response(\n\t\t\tJSON.stringify({\n\t\t\t\terror: {\n\t\t\t\t\tcode: \"CACHE_READ_ERROR\",\n\t\t\t\t\tmessage: \"Failed to read from cache\",\n\t\t\t\t},\n\t\t\t}),\n\t\t\t{\n\t\t\t\tstatus: 500,\n\t\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t\t},\n\t\t);\n\t}\n}\n\n/**\n * PUT /cache/:org/:repo\n * Update cache entry after successful processing\n *\n * Request Body:\n * {\n *   pushedAt: string,      // ISO 8601 timestamp from repos.json\n *   processedAt: string,   // ISO 8601 timestamp when processed\n *   status: string         // \"complete\"\n * }\n *\n * Response:\n * - 204: Cache updated successfully\n * - 400: Invalid parameters or body\n * - 500: Server error\n */\nexport async function putCacheEntry(\n\turl: URL,\n\trequest: Request,\n\tenv: Env,\n\trequestId: string,\n): Promise<Response> {\n\tconst parsed = parseOrgRepo(url.pathname);\n\n\tif (!parsed) {\n\t\tlogger.warn(\"Invalid cache PUT request\", {\n\t\t\trequestId,\n\t\t\tpath: url.pathname,\n\t\t});\n\t\treturn new Response(\n\t\t\tJSON.stringify({\n\t\t\t\terror: {\n\t\t\t\t\tcode: \"INVALID_PATH\",\n\t\t\t\t\tmessage: \"Expected format: /cache/:org/:repo\",\n\t\t\t\t},\n\t\t\t}),\n\t\t\t{\n\t\t\t\tstatus: 400,\n\t\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t\t},\n\t\t);\n\t}\n\n\tconst { org, repo } = parsed;\n\n\ttry {\n\t\t// Parse request body\n\t\tconst body = (await request.json()) as CacheEntry;\n\n\t\tif (!body.pushedAt || !body.processedAt || !body.status) {\n\t\t\treturn new Response(\n\t\t\t\tJSON.stringify({\n\t\t\t\t\terror: {\n\t\t\t\t\t\tcode: \"INVALID_BODY\",\n\t\t\t\t\t\tmessage: \"Request body must include: pushedAt, processedAt, status\",\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t\t{\n\t\t\t\t\tstatus: 400,\n\t\t\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t\t\t},\n\t\t\t);\n\t\t}\n\n\t\t// Use existing cache update logic\n\t\tawait updateCache(\n\t\t\t{ org, name: repo, pushedAt: body.pushedAt, url: `https://github.com/${org}/${repo}` },\n\t\t\tenv.KV,\n\t\t);\n\n\t\tlogger.info(\"Cache proxy: updated\", {\n\t\t\trequestId,\n\t\t\torg,\n\t\t\trepo,\n\t\t\tpushedAt: body.pushedAt,\n\t\t});\n\n\t\treturn new Response(null, {\n\t\t\tstatus: 204,\n\t\t});\n\t} catch (error) {\n\t\tlogger.error(\"Cache PUT failed\", {\n\t\t\trequestId,\n\t\t\torg,\n\t\t\trepo,\n\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t});\n\n\t\treturn new Response(\n\t\t\tJSON.stringify({\n\t\t\t\terror: {\n\t\t\t\t\tcode: \"CACHE_WRITE_ERROR\",\n\t\t\t\t\tmessage: \"Failed to update cache\",\n\t\t\t\t},\n\t\t\t}),\n\t\t\t{\n\t\t\t\tstatus: 500,\n\t\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t\t},\n\t\t);\n\t}\n}\n\n/**\n * GET /cache/stats\n * Get cache performance statistics\n *\n * Response:\n * {\n *   totalChecks: number,\n *   hits: number,\n *   misses: number,\n *   hitRate: number  // percentage\n * }\n */\nexport async function getCacheStatistics(requestId: string): Promise<Response> {\n\tconst stats = getCacheStats();\n\n\tlogger.info(\"Cache stats requested\", {\n\t\trequestId,\n\t\thitRate: `${stats.hitRate.toFixed(1)}%`,\n\t});\n\n\treturn new Response(JSON.stringify(stats), {\n\t\tstatus: 200,\n\t\theaders: { \"Content-Type\": \"application/json\" },\n\t});\n}\n", "/**\n * AI Search Client for Cloudflare Workers\n * Provides semantic search functionality over gitingest summaries using Cloudflare AI Search\n *\n * Features:\n * - Query validation (length, format)\n * - Retry logic with exponential backoff\n * - Structured JSON logging\n * - Performance monitoring\n * - Error handling with custom error types\n *\n * @example\n * ```typescript\n * import { searchCode } from './search/ai-search-client';\n *\n * const results = await searchCode(env, 'authentication methods', 5);\n * console.log(`Found ${results.length} results`);\n * ```\n */\n\nimport type { AISearchResult } from \"../types\";\nimport { ValidationError, ServiceError } from \"../utils/error-handler\";\nimport { createLogger } from \"../utils/logger\";\n\n// Validation constants\nconst MIN_QUERY_LENGTH = 3;\nconst MAX_QUERY_LENGTH = 500;\nconst MIN_LIMIT = 1;\nconst MAX_LIMIT = 20;\n\n// AI Search index name (configured in Cloudflare Dashboard)\nconst AI_SEARCH_INDEX_NAME = \"govreposcrape-search\";\n\n// Retry configuration\nconst MAX_RETRIES = 3;\nconst RETRY_DELAYS = [1000, 2000, 4000]; // milliseconds\n\n// Performance threshold\nconst SLOW_QUERY_THRESHOLD = 800; // milliseconds\n\n/**\n * Sleep for specified milliseconds\n * @param ms Milliseconds to sleep\n * @returns Promise that resolves after delay\n */\nasync function sleep(ms: number): Promise<void> {\n\treturn new Promise((resolve) => setTimeout(resolve, ms));\n}\n\n/**\n * Validate search query string\n * @param query Search query to validate\n * @throws ValidationError if query is invalid\n */\nexport function validateQuery(query: string): void {\n\tif (!query || query.trim().length < MIN_QUERY_LENGTH) {\n\t\tthrow new ValidationError(\n\t\t\t`Query must be at least ${MIN_QUERY_LENGTH} characters`,\n\t\t\t\"QUERY_TOO_SHORT\",\n\t\t);\n\t}\n\n\tif (query.length > MAX_QUERY_LENGTH) {\n\t\tthrow new ValidationError(\n\t\t\t`Query must not exceed ${MAX_QUERY_LENGTH} characters`,\n\t\t\t\"QUERY_TOO_LONG\",\n\t\t);\n\t}\n}\n\n/**\n * Validate result limit parameter\n * @param limit Number of results to return\n * @throws ValidationError if limit is out of range\n */\nexport function validateLimit(limit: number): void {\n\tif (limit < MIN_LIMIT || limit > MAX_LIMIT) {\n\t\tthrow new ValidationError(\n\t\t\t`Limit must be between ${MIN_LIMIT} and ${MAX_LIMIT}`,\n\t\t\t\"INVALID_LIMIT\",\n\t\t);\n\t}\n}\n\n/**\n * Retry a function with exponential backoff\n * @param fn Function to retry\n * @param operation Operation name for logging\n * @param requestId Request correlation ID\n * @returns Promise of function result\n * @throws ServiceError after max retries exceeded\n */\nexport async function withRetry<T>(\n\tfn: () => Promise<T>,\n\toperation: string,\n\trequestId: string,\n): Promise<T> {\n\tconst logger = createLogger({ operation, requestId });\n\tlet lastError: Error;\n\n\tfor (let attempt = 0; attempt < MAX_RETRIES; attempt++) {\n\t\ttry {\n\t\t\treturn await fn();\n\t\t} catch (error) {\n\t\t\tlastError = error as Error;\n\n\t\t\tlogger.info(\"Retry attempt\", {\n\t\t\t\tattempt: attempt + 1,\n\t\t\t\tmaxRetries: MAX_RETRIES,\n\t\t\t\terror: lastError.message,\n\t\t\t});\n\n\t\t\t// Don't sleep after the last attempt\n\t\t\tif (attempt < MAX_RETRIES - 1) {\n\t\t\t\tawait sleep(RETRY_DELAYS[attempt]);\n\t\t\t}\n\t\t}\n\t}\n\n\t// All retries failed\n\tthrow new ServiceError(\n\t\t`AI Search service unavailable after ${MAX_RETRIES} attempts`,\n\t\t503,\n\t\t\"SEARCH_ERROR\",\n\t\t60, // retry_after in seconds\n\t);\n}\n\n/**\n * Execute semantic search query against indexed gitingest summaries\n *\n * Validates input parameters, executes query with retry logic,\n * logs performance metrics, and returns ranked results.\n *\n * @param env Workers environment with AI_SEARCH binding (Env from worker-configuration.d.ts)\n * @param query Natural language search query (3-500 chars)\n * @param limit Number of results to return (1-20)\n * @returns Array of search results ranked by similarity\n * @throws ValidationError if query/limit invalid\n * @throws ServiceError if AI Search unavailable after retries\n *\n * @example\n * ```typescript\n * const results = await searchCode(env, 'authentication methods', 5);\n * results.forEach(result => {\n *   console.log(`Score: ${result.score}, Path: ${result.metadata.path}`);\n * });\n * ```\n */\nexport async function searchCode(\n\tenv: Env,\n\tquery: string,\n\tlimit: number = 5,\n): Promise<AISearchResult[]> {\n\t// Generate correlation ID for distributed tracing\n\tconst requestId = crypto.randomUUID();\n\tconst startTime = Date.now();\n\tconst logger = createLogger({ operation: \"search\", requestId });\n\n\t// Validate inputs before making any external calls\n\tvalidateQuery(query);\n\tvalidateLimit(limit);\n\n\tlogger.info(\"AI Search query started\", {\n\t\tquery,\n\t\tlimit,\n\t});\n\n\ttry {\n\t\t// Execute query with retry logic\n\t\t// API usage: env.AI.autorag(\"index-name\").search({ query, max_num_results })\n\t\tconst response = await withRetry(\n\t\t\t() =>\n\t\t\t\tenv.AI.autorag(AI_SEARCH_INDEX_NAME).search({\n\t\t\t\t\tquery,\n\t\t\t\t\tmax_num_results: limit,\n\t\t\t\t}),\n\t\t\t\"ai_search_query\",\n\t\t\trequestId,\n\t\t);\n\n\t\tconst duration = Date.now() - startTime;\n\t\tconst resultCount = response.data.length;\n\n\t\t// Log successful completion with performance metrics\n\t\tlogger.info(\"AI Search query completed\", {\n\t\t\tduration,\n\t\t\tresultCount,\n\t\t\taiSearchTookMs: response.took_ms,\n\t\t\tsearchQuery: response.search_query,\n\t\t});\n\n\t\t// Warn on slow queries for investigation\n\t\tif (duration > SLOW_QUERY_THRESHOLD) {\n\t\t\tlogger.warn(\"Slow AI Search query detected\", {\n\t\t\t\tduration,\n\t\t\t\tthreshold: SLOW_QUERY_THRESHOLD,\n\t\t\t\tquery,\n\t\t\t});\n\t\t}\n\n\t\treturn response.data;\n\t} catch (error) {\n\t\tconst duration = Date.now() - startTime;\n\n\t\t// Log query failure with context\n\t\tlogger.error(\"AI Search query failed\", {\n\t\t\tduration,\n\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\tquery,\n\t\t});\n\n\t\t// Re-throw the error for caller to handle\n\t\tthrow error;\n\t}\n}\n", "/**\n * Result Enrichment Module for AI Search Results\n * Enriches raw AI Search results with GitHub metadata, links, and R2 custom metadata\n *\n * Features:\n * - R2 path parsing to extract org/repo information\n * - GitHub, Codespaces, and Gitpod link generation\n * - R2 metadata fetching (pushedAt, url, processedAt)\n * - Graceful degradation when metadata unavailable\n * - Performance monitoring (<100ms per result target)\n *\n * @example\n * ```typescript\n * import { enrichResult, enrichResults } from './search/result-enricher';\n *\n * const results = await searchCode(env, 'authentication', 5);\n * const enriched = await enrichResults(env, results);\n * console.log(enriched.map(r => r.links.github));\n * ```\n */\n\nimport type { AISearchResult, EnrichedSearchResult } from \"../types\";\nimport { createLogger } from \"../utils/logger\";\n\n// Performance threshold for slow enrichment warnings\nconst SLOW_ENRICHMENT_THRESHOLD = 100; // milliseconds\n\n/**\n * Parsed R2 path result structure\n */\nexport interface ParsedR2Path {\n\torg: string;\n\trepo: string;\n\tvalid: boolean;\n\terror?: string;\n}\n\n/**\n * R2 custom metadata structure\n */\nexport interface R2Metadata {\n\tpushedAt?: string;\n\turl?: string;\n\tprocessedAt?: string;\n}\n\n/**\n * Parse R2 object path to extract organization and repository names\n *\n * Expected format: gitingest/{org}/{repo}/summary.txt\n * Handles URL encoding in org/repo names\n *\n * @param path R2 object path from AISearchResult.metadata.path\n * @returns Parsed path with org, repo, validation status, and error (if invalid)\n *\n * @example\n * ```typescript\n * const result = parseR2Path('gitingest/alphagov/govuk-frontend/summary.txt');\n * console.log(result); // { org: 'alphagov', repo: 'govuk-frontend', valid: true }\n *\n * const invalid = parseR2Path('invalid/path');\n * console.log(invalid.valid); // false\n * console.log(invalid.error); // 'Invalid R2 path format...'\n * ```\n */\nexport function parseR2Path(path: string): ParsedR2Path {\n\t// Validate input\n\tif (!path || typeof path !== \"string\") {\n\t\treturn {\n\t\t\torg: \"\",\n\t\t\trepo: \"\",\n\t\t\tvalid: false,\n\t\t\terror:\n\t\t\t\t\"Invalid path: must be a non-empty string in format gitingest/{org}/{repo}/summary.txt\",\n\t\t};\n\t}\n\n\t// Expected format: gitingest/{org}/{repo}/summary.txt\n\t// Use looser pattern to allow validation of empty segments\n\tconst pathPattern = /^gitingest\\/([^/]*)\\/([^/]*)\\/summary\\.txt$/;\n\tconst match = path.match(pathPattern);\n\n\tif (!match) {\n\t\treturn {\n\t\t\torg: \"\",\n\t\t\trepo: \"\",\n\t\t\tvalid: false,\n\t\t\terror: `Invalid R2 path format. Expected: gitingest/{org}/{repo}/summary.txt, got: ${path}`,\n\t\t};\n\t}\n\n\t// Extract and decode org/repo (handles URL encoding)\n\ttry {\n\t\tconst org = decodeURIComponent(match[1]);\n\t\tconst repo = decodeURIComponent(match[2]);\n\n\t\t// Validate extracted values are not empty after decoding\n\t\tif (!org || !repo) {\n\t\t\treturn {\n\t\t\t\torg: \"\",\n\t\t\t\trepo: \"\",\n\t\t\t\tvalid: false,\n\t\t\t\terror: \"Invalid R2 path: org or repo is empty\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\torg,\n\t\t\trepo,\n\t\t\tvalid: true,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\torg: \"\",\n\t\t\trepo: \"\",\n\t\t\tvalid: false,\n\t\t\terror: `Failed to decode org/repo from path: ${error instanceof Error ? error.message : String(error)}`,\n\t\t};\n\t}\n}\n\n/**\n * Build GitHub repository URL\n *\n * @param org GitHub organization name\n * @param repo Repository name\n * @returns Full GitHub URL: https://github.com/{org}/{repo}\n *\n * @example\n * ```typescript\n * const url = buildGitHubURL('alphagov', 'govuk-frontend');\n * console.log(url); // https://github.com/alphagov/govuk-frontend\n * ```\n */\nexport function buildGitHubURL(org: string, repo: string): string {\n\tconst encodedOrg = encodeURIComponent(org);\n\tconst encodedRepo = encodeURIComponent(repo);\n\treturn `https://github.com/${encodedOrg}/${encodedRepo}`;\n}\n\n/**\n * Build GitHub Codespaces URL for instant browser-based development\n *\n * @param org GitHub organization name\n * @param repo Repository name\n * @returns Codespaces URL: https://github.dev/{org}/{repo}\n *\n * @example\n * ```typescript\n * const url = buildCodespacesURL('alphagov', 'govuk-frontend');\n * console.log(url); // https://github.dev/alphagov/govuk-frontend\n * ```\n */\nexport function buildCodespacesURL(org: string, repo: string): string {\n\tconst encodedOrg = encodeURIComponent(org);\n\tconst encodedRepo = encodeURIComponent(repo);\n\treturn `https://github.dev/${encodedOrg}/${encodedRepo}`;\n}\n\n/**\n * Build Gitpod URL for cloud-based development environment\n *\n * @param org GitHub organization name\n * @param repo Repository name\n * @returns Gitpod URL: https://gitpod.io/#https://github.com/{org}/{repo}\n *\n * @example\n * ```typescript\n * const url = buildGitpodURL('alphagov', 'govuk-frontend');\n * console.log(url); // https://gitpod.io/#https://github.com/alphagov/govuk-frontend\n * ```\n */\nexport function buildGitpodURL(org: string, repo: string): string {\n\tconst encodedOrg = encodeURIComponent(org);\n\tconst encodedRepo = encodeURIComponent(repo);\n\tconst githubURL = `https://github.com/${encodedOrg}/${encodedRepo}`;\n\treturn `https://gitpod.io/#${githubURL}`;\n}\n\n/**\n * Fetch R2 object custom metadata using HEAD request\n *\n * Retrieves metadata stored during gitingest processing:\n * - pushedAt: Repository last push timestamp (ISO 8601)\n * - url: Full GitHub repository URL\n * - processedAt: Gitingest processing timestamp (ISO 8601)\n *\n * Implements graceful degradation: returns empty object if metadata unavailable\n *\n * @param env Workers environment with R2 binding\n * @param path R2 object path\n * @param requestId Correlation ID for distributed tracing\n * @returns Promise of R2 metadata (empty object if unavailable)\n *\n * @example\n * ```typescript\n * const metadata = await fetchR2Metadata(env, 'gitingest/alphagov/govuk-frontend/summary.txt', requestId);\n * if (metadata.pushedAt) {\n *   console.log(`Last updated: ${metadata.pushedAt}`);\n * }\n * ```\n */\nexport async function fetchR2Metadata(\n\tenv: Env,\n\tpath: string,\n\trequestId: string,\n): Promise<R2Metadata> {\n\tconst logger = createLogger({ operation: \"fetch_r2_metadata\", requestId });\n\tconst startTime = Date.now();\n\n\ttry {\n\t\tconst object = await env.R2.head(path);\n\t\tconst duration = Date.now() - startTime;\n\n\t\tif (!object) {\n\t\t\tlogger.warn(\"R2 object not found\", { path, duration });\n\t\t\treturn {};\n\t\t}\n\n\t\tlogger.info(\"R2 metadata fetched\", {\n\t\t\tpath,\n\t\t\tduration,\n\t\t\thasCustomMetadata: !!object.customMetadata,\n\t\t});\n\n\t\t// Warn if R2 HEAD request is slow (>100ms target)\n\t\tif (duration > SLOW_ENRICHMENT_THRESHOLD) {\n\t\t\tlogger.warn(\"Slow R2 HEAD request\", {\n\t\t\t\tpath,\n\t\t\t\tduration,\n\t\t\t\tthreshold: SLOW_ENRICHMENT_THRESHOLD,\n\t\t\t});\n\t\t}\n\n\t\t// Extract custom metadata if available\n\t\treturn {\n\t\t\tpushedAt: object.customMetadata?.pushedAt,\n\t\t\turl: object.customMetadata?.url,\n\t\t\tprocessedAt: object.customMetadata?.processedAt,\n\t\t};\n\t} catch (error) {\n\t\tconst duration = Date.now() - startTime;\n\t\tlogger.error(\"R2 metadata fetch failed\", {\n\t\t\tpath,\n\t\t\tduration,\n\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t});\n\t\t// Graceful degradation: return empty metadata instead of throwing\n\t\treturn {};\n\t}\n}\n\n/**\n * Enrich a single AI Search result with repository metadata and actionable links\n *\n * Transforms raw AI Search results into user-friendly results with:\n * - Repository information (org, name, fullName)\n * - Quick-launch links (GitHub, Codespaces, Gitpod)\n * - R2 custom metadata (pushedAt, url, processedAt)\n *\n * Implements graceful degradation:\n * - Invalid R2 path \u2192 returns minimal enrichment with 'unknown' values\n * - R2 metadata unavailable \u2192 returns enriched result without metadata field\n *\n * Performance target: <100ms per result (measured and logged)\n *\n * @param env Workers environment with R2 binding\n * @param rawResult Raw AI Search result from searchCode()\n * @returns Promise of enriched result with metadata and links\n *\n * @example\n * ```typescript\n * const rawResult: AISearchResult = {\n *   content: 'function authenticate() { ... }',\n *   score: 0.92,\n *   metadata: { path: 'gitingest/alphagov/govuk-frontend/summary.txt', contentType: 'text/plain' }\n * };\n *\n * const enriched = await enrichResult(env, rawResult);\n * console.log(enriched.links.github); // https://github.com/alphagov/govuk-frontend\n * console.log(enriched.repository.fullName); // alphagov/govuk-frontend\n * console.log(enriched.metadata?.pushedAt); // 2025-01-15T10:00:00Z\n * ```\n */\nexport async function enrichResult(\n\tenv: Env,\n\trawResult: AISearchResult,\n): Promise<EnrichedSearchResult> {\n\tconst requestId = crypto.randomUUID();\n\tconst logger = createLogger({ operation: \"enrich_result\", requestId });\n\tconst startTime = Date.now();\n\n\t// Parse R2 path to extract org/repo\n\tconst parsed = parseR2Path(rawResult.metadata.path);\n\n\tif (!parsed.valid) {\n\t\tlogger.error(\"Invalid R2 path\", {\n\t\t\tpath: rawResult.metadata.path,\n\t\t\terror: parsed.error,\n\t\t});\n\n\t\t// Return minimal enrichment for invalid paths (graceful degradation)\n\t\tconst duration = Date.now() - startTime;\n\t\tlogger.info(\"Result enrichment completed (minimal)\", { duration });\n\n\t\treturn {\n\t\t\tcontent: rawResult.content,\n\t\t\tscore: rawResult.score,\n\t\t\trepository: {\n\t\t\t\torg: \"unknown\",\n\t\t\t\tname: \"unknown\",\n\t\t\t\tfullName: \"unknown/unknown\",\n\t\t\t},\n\t\t\tlinks: {\n\t\t\t\tgithub: \"\",\n\t\t\t\tcodespaces: \"\",\n\t\t\t\tgitpod: \"\",\n\t\t\t},\n\t\t\tr2Path: rawResult.metadata.path,\n\t\t};\n\t}\n\n\t// Generate quick-launch links\n\tconst githubURL = buildGitHubURL(parsed.org, parsed.repo);\n\tconst codespacesURL = buildCodespacesURL(parsed.org, parsed.repo);\n\tconst gitpodURL = buildGitpodURL(parsed.org, parsed.repo);\n\n\t// Fetch R2 metadata (with graceful degradation)\n\tconst r2Metadata = await fetchR2Metadata(env, rawResult.metadata.path, requestId);\n\n\tconst duration = Date.now() - startTime;\n\n\tlogger.info(\"Result enriched\", {\n\t\tduration,\n\t\torg: parsed.org,\n\t\trepo: parsed.repo,\n\t\thasMetadata: Object.keys(r2Metadata).length > 0,\n\t});\n\n\t// Warn if enrichment is slow (>100ms target)\n\tif (duration > SLOW_ENRICHMENT_THRESHOLD) {\n\t\tlogger.warn(\"Slow result enrichment\", {\n\t\t\tduration,\n\t\t\tthreshold: SLOW_ENRICHMENT_THRESHOLD,\n\t\t\torg: parsed.org,\n\t\t\trepo: parsed.repo,\n\t\t});\n\t}\n\n\t// Build enriched result\n\tconst enrichedResult: EnrichedSearchResult = {\n\t\tcontent: rawResult.content,\n\t\tscore: rawResult.score,\n\t\trepository: {\n\t\t\torg: parsed.org,\n\t\t\tname: parsed.repo,\n\t\t\tfullName: `${parsed.org}/${parsed.repo}`,\n\t\t},\n\t\tlinks: {\n\t\t\tgithub: githubURL,\n\t\t\tcodespaces: codespacesURL,\n\t\t\tgitpod: gitpodURL,\n\t\t},\n\t\tr2Path: rawResult.metadata.path,\n\t};\n\n\t// Only include metadata field if we have data (optional field pattern)\n\tif (Object.keys(r2Metadata).length > 0) {\n\t\tenrichedResult.metadata = r2Metadata;\n\t}\n\n\treturn enrichedResult;\n}\n\n/**\n * Enrich multiple AI Search results in parallel\n *\n * Processes array of raw results concurrently using Promise.all for performance.\n * Each result is enriched independently with repository metadata and links.\n *\n * Performance target: <100ms average per result\n * Logs: total duration, result count, average duration per result\n *\n * @param env Workers environment with R2 binding\n * @param rawResults Array of raw AI Search results\n * @returns Promise of enriched results array (same order as input)\n *\n * @example\n * ```typescript\n * const results = await searchCode(env, 'authentication', 5);\n * const enriched = await enrichResults(env, results);\n *\n * enriched.forEach(result => {\n *   console.log(`${result.repository.fullName}: ${result.links.github}`);\n * });\n * ```\n */\nexport async function enrichResults(\n\tenv: Env,\n\trawResults: AISearchResult[],\n): Promise<EnrichedSearchResult[]> {\n\tconst requestId = crypto.randomUUID();\n\tconst logger = createLogger({ operation: \"enrich_results\", requestId });\n\tconst startTime = Date.now();\n\n\t// Parallel enrichment for performance\n\tconst enrichedResults = await Promise.all(rawResults.map((result) => enrichResult(env, result)));\n\n\tconst duration = Date.now() - startTime;\n\tconst avgDuration = rawResults.length > 0 ? duration / rawResults.length : 0;\n\n\tlogger.info(\"Batch enrichment complete\", {\n\t\tduration,\n\t\tresultCount: rawResults.length,\n\t\tavgDuration: Math.round(avgDuration),\n\t});\n\n\t// Warn if average enrichment time exceeds target\n\tif (avgDuration > SLOW_ENRICHMENT_THRESHOLD) {\n\t\tlogger.warn(\"Slow batch enrichment\", {\n\t\t\tavgDuration: Math.round(avgDuration),\n\t\t\tthreshold: SLOW_ENRICHMENT_THRESHOLD,\n\t\t\tresultCount: rawResults.length,\n\t\t});\n\t}\n\n\treturn enrichedResults;\n}\n", "/**\n * Custom Metrics Collection for govscraperepo Observability Dashboard\n *\n * Extends Cloudflare Workers Analytics with custom tracking:\n * - Cache hit rate (KV cache efficiency)\n * - Empty result rate (queries returning zero results)\n * - Slow query rate (queries exceeding 2s threshold)\n * - Error type breakdown (categorized error tracking)\n *\n * Metrics are emitted via structured JSON logging (src/utils/logger.ts)\n * compatible with Cloudflare Workers log streaming.\n *\n * @see Story 6.3: Observability Dashboard - Key Metrics and KPIs\n * @see docs/PRD.md - FR-8 (usage metrics), NFR-1 (performance), NFR-6 (reliability)\n */\n\nimport type { Logger } from \"./logger\";\n\n/**\n * Observability metrics snapshot for a given period\n * Aligned with PRD success criteria and MVP targets\n */\nexport interface ObservabilityMetrics {\n\t/** Time period for these metrics (e.g., \"2025-11-15\", \"2025-W46\") */\n\tperiod: string;\n\t/** Total query volume in the period */\n\tquery_volume: number;\n\t/** Unique users (optional, if trackable) */\n\tunique_users?: number;\n\t/** 50th percentile response time (milliseconds) */\n\tresponse_time_p50: number;\n\t/** 95th percentile response time (milliseconds) - <2000ms target (NFR-1.1) */\n\tresponse_time_p95: number;\n\t/** 99th percentile response time (milliseconds) */\n\tresponse_time_p99: number;\n\t/** Error rate as percentage (0-100) - <1% target (NFR-6.3) */\n\terror_rate: number;\n\t/** Cache hit rate as percentage (0-100) - 90%+ target (NFR-1.4) */\n\tcache_hit_rate: number;\n\t/** Empty result rate as percentage (0-100) */\n\tempty_result_rate: number;\n\t/** Slow query rate as percentage (0-100) - queries >2s */\n\tslow_query_rate: number;\n\t/** MVP success metrics */\n\tmvp_success_metrics?: MVPSuccessMetrics;\n}\n\n/**\n * MVP success criteria metrics\n * Tracks \"hundreds of uses per week\" and performance/reliability targets\n */\nexport interface MVPSuccessMetrics {\n\t/** Weekly query volume (target: 200+ queries/week = \"hundreds\") */\n\tweekly_queries: number;\n\t/** Adoption trend: increasing, stable, decreasing */\n\tadoption_trend: \"increasing\" | \"stable\" | \"decreasing\";\n\t/** Performance compliance: p95 < 2s (NFR-1.1) */\n\tperformance_compliance: boolean;\n\t/** Reliability compliance: error rate < 1% (NFR-6.3) */\n\treliability_compliance: boolean;\n\t/** Cache efficiency compliance: hit rate > 90% (NFR-1.4) */\n\tcache_efficiency_compliance: boolean;\n}\n\n/**\n * Custom metrics collector state\n * Tracks counters for cache hits, empty results, and slow queries\n */\nexport interface MetricsCollector {\n\t/** Total cache checks performed */\n\ttotal_cache_checks: number;\n\t/** Successful cache hits */\n\tcache_hits: number;\n\t/** Total queries executed */\n\ttotal_queries: number;\n\t/** Queries returning zero results */\n\tqueries_with_zero_results: number;\n\t/** Queries exceeding 2-second threshold */\n\tqueries_over_2s: number;\n\t/** Error count by type */\n\terrors_by_type: Record<string, number>;\n}\n\n/**\n * Calculate cache hit rate from collector state\n *\n * @param collector - Metrics collector with cache statistics\n * @returns Cache hit rate as percentage (0-100)\n *\n * @example\n * ```typescript\n * const collector = { total_cache_checks: 100, cache_hits: 92, ... };\n * const hitRate = calculateCacheHitRate(collector);\n * // hitRate = 92.0\n * ```\n */\nexport function calculateCacheHitRate(collector: MetricsCollector): number {\n\tif (collector.total_cache_checks === 0) {\n\t\treturn 0;\n\t}\n\treturn (collector.cache_hits / collector.total_cache_checks) * 100;\n}\n\n/**\n * Calculate empty result rate from collector state\n *\n * @param collector - Metrics collector with query statistics\n * @returns Empty result rate as percentage (0-100)\n *\n * @example\n * ```typescript\n * const collector = { total_queries: 100, queries_with_zero_results: 15, ... };\n * const emptyRate = calculateEmptyResultRate(collector);\n * // emptyRate = 15.0\n * ```\n */\nexport function calculateEmptyResultRate(collector: MetricsCollector): number {\n\tif (collector.total_queries === 0) {\n\t\treturn 0;\n\t}\n\treturn (collector.queries_with_zero_results / collector.total_queries) * 100;\n}\n\n/**\n * Calculate slow query rate from collector state\n *\n * @param collector - Metrics collector with query timing statistics\n * @returns Slow query rate as percentage (0-100)\n *\n * @example\n * ```typescript\n * const collector = { total_queries: 100, queries_over_2s: 3, ... };\n * const slowRate = calculateSlowQueryRate(collector);\n * // slowRate = 3.0\n * ```\n */\nexport function calculateSlowQueryRate(collector: MetricsCollector): number {\n\tif (collector.total_queries === 0) {\n\t\treturn 0;\n\t}\n\treturn (collector.queries_over_2s / collector.total_queries) * 100;\n}\n\n/**\n * Track cache check result and update collector state\n *\n * Increments total cache checks and hits counters.\n * Integrates with Epic 2 caching (KV-based smart caching).\n *\n * @param collector - Metrics collector to update\n * @param hit - Whether cache check resulted in a hit (true) or miss (false)\n * @param logger - Optional logger for structured logging\n *\n * @example\n * ```typescript\n * const collector = createMetricsCollector();\n * const logger = createLogger({ operation: 'cache_check' });\n *\n * // Cache hit\n * trackCacheCheck(collector, true, logger);\n *\n * // Cache miss\n * trackCacheCheck(collector, false, logger);\n * ```\n */\nexport function trackCacheCheck(collector: MetricsCollector, hit: boolean, logger?: Logger): void {\n\tcollector.total_cache_checks++;\n\tif (hit) {\n\t\tcollector.cache_hits++;\n\t}\n\n\tif (logger) {\n\t\tlogger.debug(\"Cache check tracked\", {\n\t\t\thit,\n\t\t\ttotal_checks: collector.total_cache_checks,\n\t\t\thits: collector.cache_hits,\n\t\t\thit_rate: calculateCacheHitRate(collector).toFixed(2),\n\t\t});\n\t}\n}\n\n/**\n * Track query result and update collector state\n *\n * Increments total queries counter and tracks empty results.\n * Used to monitor query quality and relevance.\n *\n * @param collector - Metrics collector to update\n * @param resultCount - Number of results returned by the query\n * @param logger - Optional logger for structured logging\n *\n * @example\n * ```typescript\n * const collector = createMetricsCollector();\n * const logger = createLogger({ operation: 'execute_search' });\n *\n * // Query with results\n * trackQueryResult(collector, 5, logger);\n *\n * // Query with no results\n * trackQueryResult(collector, 0, logger);\n * ```\n */\nexport function trackQueryResult(\n\tcollector: MetricsCollector,\n\tresultCount: number,\n\tlogger?: Logger,\n): void {\n\tcollector.total_queries++;\n\tif (resultCount === 0) {\n\t\tcollector.queries_with_zero_results++;\n\t}\n\n\tif (logger) {\n\t\tlogger.debug(\"Query result tracked\", {\n\t\t\tresult_count: resultCount,\n\t\t\tempty: resultCount === 0,\n\t\t\ttotal_queries: collector.total_queries,\n\t\t\tempty_rate: calculateEmptyResultRate(collector).toFixed(2),\n\t\t});\n\t}\n}\n\n/**\n * Track query duration and update collector state\n *\n * Increments slow query counter if duration exceeds 2-second threshold (NFR-1.1).\n * Helps identify performance degradation and optimization opportunities.\n *\n * @param collector - Metrics collector to update\n * @param durationMs - Query execution time in milliseconds\n * @param logger - Optional logger for structured logging\n *\n * @example\n * ```typescript\n * const collector = createMetricsCollector();\n * const logger = createLogger({ operation: 'execute_search' });\n *\n * // Fast query (1.2s)\n * trackQueryDuration(collector, 1200, logger);\n *\n * // Slow query (2.5s)\n * trackQueryDuration(collector, 2500, logger);\n * ```\n */\nexport function trackQueryDuration(\n\tcollector: MetricsCollector,\n\tdurationMs: number,\n\tlogger?: Logger,\n): void {\n\tconst SLOW_QUERY_THRESHOLD_MS = 2000; // NFR-1.1: <2s p95 target\n\n\tif (durationMs > SLOW_QUERY_THRESHOLD_MS) {\n\t\tcollector.queries_over_2s++;\n\n\t\tif (logger) {\n\t\t\tlogger.warn(\"Slow query detected\", {\n\t\t\t\tduration_ms: durationMs,\n\t\t\t\tthreshold_ms: SLOW_QUERY_THRESHOLD_MS,\n\t\t\t\tslow_query_rate: calculateSlowQueryRate(collector).toFixed(2),\n\t\t\t});\n\t\t}\n\t} else if (logger) {\n\t\tlogger.debug(\"Query duration tracked\", {\n\t\t\tduration_ms: durationMs,\n\t\t\tslow: false,\n\t\t});\n\t}\n}\n\n/**\n * Track error by type and update collector state\n *\n * Categorizes errors for analysis (validation, AI Search timeout, service errors, etc.).\n * Helps identify systemic issues and prioritize fixes.\n *\n * @param collector - Metrics collector to update\n * @param errorType - Error category (e.g., \"VALIDATION_ERROR\", \"AI_SEARCH_TIMEOUT\", \"SERVICE_ERROR\")\n * @param logger - Optional logger for structured logging\n *\n * @example\n * ```typescript\n * const collector = createMetricsCollector();\n * const logger = createLogger({ operation: 'error_handler' });\n *\n * // Track validation error\n * trackError(collector, \"VALIDATION_ERROR\", logger);\n *\n * // Track AI Search timeout\n * trackError(collector, \"AI_SEARCH_TIMEOUT\", logger);\n * ```\n */\nexport function trackError(collector: MetricsCollector, errorType: string, logger?: Logger): void {\n\tif (!collector.errors_by_type[errorType]) {\n\t\tcollector.errors_by_type[errorType] = 0;\n\t}\n\tcollector.errors_by_type[errorType]++;\n\n\tif (logger) {\n\t\tlogger.debug(\"Error tracked\", {\n\t\t\terror_type: errorType,\n\t\t\tcount: collector.errors_by_type[errorType],\n\t\t\ttotal_error_types: Object.keys(collector.errors_by_type).length,\n\t\t});\n\t}\n}\n\n/**\n * Create a new metrics collector instance\n *\n * Initializes all counters to zero for tracking session metrics.\n *\n * @returns Fresh metrics collector with zero counters\n *\n * @example\n * ```typescript\n * const collector = createMetricsCollector();\n * // collector = { total_cache_checks: 0, cache_hits: 0, ... }\n * ```\n */\nexport function createMetricsCollector(): MetricsCollector {\n\treturn {\n\t\ttotal_cache_checks: 0,\n\t\tcache_hits: 0,\n\t\ttotal_queries: 0,\n\t\tqueries_with_zero_results: 0,\n\t\tqueries_over_2s: 0,\n\t\terrors_by_type: {},\n\t};\n}\n\n/**\n * Generate observability metrics snapshot from collector state\n *\n * Aggregates collected metrics into a structured snapshot for export or reporting.\n * Calculates derived metrics (rates, percentages) and validates against MVP targets.\n *\n * @param collector - Metrics collector with accumulated statistics\n * @param period - Time period identifier (e.g., \"2025-11-15\", \"2025-W46\")\n * @param p50 - 50th percentile response time (milliseconds)\n * @param p95 - 95th percentile response time (milliseconds)\n * @param p99 - 99th percentile response time (milliseconds)\n * @param errorRate - Error rate as percentage (0-100)\n * @param weeklyQueries - Optional weekly query volume for MVP tracking\n * @param previousWeeklyQueries - Optional previous week's query volume for trend analysis\n * @returns Observability metrics snapshot\n *\n * @example\n * ```typescript\n * const collector = createMetricsCollector();\n * // ... accumulate metrics via track*() functions ...\n *\n * const snapshot = generateMetricsSnapshot(\n *   collector,\n *   \"2025-11-15\",\n *   456, // p50\n *   1234, // p95\n *   1876, // p99\n *   0.04, // 0.04% error rate\n *   234, // weekly queries\n *   198 // previous week\n * );\n * ```\n */\nexport function generateMetricsSnapshot(\n\tcollector: MetricsCollector,\n\tperiod: string,\n\tp50: number,\n\tp95: number,\n\tp99: number,\n\terrorRate: number,\n\tweeklyQueries?: number,\n\tpreviousWeeklyQueries?: number,\n): ObservabilityMetrics {\n\tconst cacheHitRate = calculateCacheHitRate(collector);\n\tconst emptyResultRate = calculateEmptyResultRate(collector);\n\tconst slowQueryRate = calculateSlowQueryRate(collector);\n\n\tconst metrics: ObservabilityMetrics = {\n\t\tperiod,\n\t\tquery_volume: collector.total_queries,\n\t\tresponse_time_p50: p50,\n\t\tresponse_time_p95: p95,\n\t\tresponse_time_p99: p99,\n\t\terror_rate: errorRate,\n\t\tcache_hit_rate: cacheHitRate,\n\t\tempty_result_rate: emptyResultRate,\n\t\tslow_query_rate: slowQueryRate,\n\t};\n\n\t// Calculate MVP success metrics if weekly data available\n\tif (weeklyQueries !== undefined) {\n\t\tconst performanceCompliance = p95 < 2000; // NFR-1.1: <2s p95\n\t\tconst reliabilityCompliance = errorRate < 1; // NFR-6.3: <1% error rate\n\t\tconst cacheEfficiencyCompliance = cacheHitRate > 90; // NFR-1.4: >90% hit rate\n\n\t\tlet adoptionTrend: \"increasing\" | \"stable\" | \"decreasing\" = \"stable\";\n\t\tif (previousWeeklyQueries !== undefined) {\n\t\t\tconst growth = ((weeklyQueries - previousWeeklyQueries) / previousWeeklyQueries) * 100;\n\t\t\tif (growth > 5) {\n\t\t\t\tadoptionTrend = \"increasing\";\n\t\t\t} else if (growth < -5) {\n\t\t\t\tadoptionTrend = \"decreasing\";\n\t\t\t}\n\t\t}\n\n\t\tmetrics.mvp_success_metrics = {\n\t\t\tweekly_queries: weeklyQueries,\n\t\t\tadoption_trend: adoptionTrend,\n\t\t\tperformance_compliance: performanceCompliance,\n\t\t\treliability_compliance: reliabilityCompliance,\n\t\t\tcache_efficiency_compliance: cacheEfficiencyCompliance,\n\t\t};\n\t}\n\n\treturn metrics;\n}\n\n/**\n * Evaluate MVP success criteria from metrics snapshot\n *\n * Validates metrics against PRD targets:\n * - Weekly query volume: \u2265200 queries/week (\"hundreds\")\n * - Performance: p95 <2s (NFR-1.1)\n * - Reliability: error rate <1% (NFR-6.3)\n * - Cache efficiency: hit rate >90% (NFR-1.4)\n *\n * @param metrics - Observability metrics snapshot\n * @returns true if all MVP criteria met, false otherwise\n *\n * @example\n * ```typescript\n * const metrics = generateMetricsSnapshot(...);\n * const mvpSuccess = evaluateMVPSuccess(metrics);\n *\n * if (!mvpSuccess) {\n *   console.log(\"MVP success criteria NOT met - review metrics\");\n * }\n * ```\n */\nexport function evaluateMVPSuccess(metrics: ObservabilityMetrics): boolean {\n\tif (!metrics.mvp_success_metrics) {\n\t\treturn false; // Cannot evaluate without MVP metrics\n\t}\n\n\tconst mvp = metrics.mvp_success_metrics;\n\tconst MIN_WEEKLY_QUERIES = 200; // \"Hundreds of uses per week\" = 200+ queries\n\n\treturn (\n\t\tmvp.weekly_queries >= MIN_WEEKLY_QUERIES &&\n\t\tmvp.performance_compliance &&\n\t\tmvp.reliability_compliance &&\n\t\tmvp.cache_efficiency_compliance &&\n\t\tmvp.adoption_trend !== \"decreasing\"\n\t);\n}\n", "/**\n * Search Endpoint for MCP API\n * Integrates Cloudflare AI Search with MCP response format\n *\n * This module orchestrates the search pipeline:\n * 1. Execute AI Search query via searchCode() (Epic 3 Story 3.2)\n * 2. Enrich results with metadata via enrichResults() (Epic 3 Story 3.3)\n * 3. Map enriched results to MCP SearchResult format\n * 4. Build MCPResponse with timing information\n *\n * @module search-endpoint\n */\n\nimport { searchCode } from \"../search/ai-search-client\";\nimport { enrichResults } from \"../search/result-enricher\";\nimport { createLogger } from \"../utils/logger\";\nimport { ServiceError } from \"../utils/error-handler\";\nimport {\n\ttrackQueryResult,\n\ttrackQueryDuration,\n\ttrackError,\n\ttype MetricsCollector,\n} from \"../utils/metrics\";\nimport type { MCPRequest, MCPResponse, SearchResult, EnrichedSearchResult } from \"../types\";\n\n/**\n * Execute semantic search and return MCP-formatted results\n *\n * Orchestrates the complete search pipeline:\n * - Queries Cloudflare AI Search for code snippets\n * - Enriches results with repository metadata and links\n * - Maps to MCP SearchResult format\n * - Tracks performance metrics\n *\n * @param request - Validated MCPRequest with query and optional limit\n * @param env - Cloudflare Workers environment bindings\n * @param metricsCollector - Optional metrics collector for tracking custom metrics (Story 6.3)\n * @returns MCPResponse with enriched search results and timing\n * @throws ServiceError on AI Search failures (503 with retry_after)\n *\n * @example\n * ```typescript\n * const request = { query: \"authentication methods\", limit: 5 };\n * const response = await executeSearch(request, env);\n * // response = { results: [{ repository: \"alphagov/...\", ... }], took_ms: 234 }\n * ```\n */\nexport async function executeSearch(\n\trequest: MCPRequest,\n\tenv: Env,\n\tmetricsCollector?: MetricsCollector,\n): Promise<MCPResponse> {\n\tconst startTime = Date.now();\n\tconst requestId = crypto.randomUUID();\n\tconst logger = createLogger({ operation: \"execute_search\", requestId });\n\n\tlogger.info(\"Search request started\", {\n\t\tquery: request.query.substring(0, 100), // Truncate for privacy (Story 4.1 pattern)\n\t\tlimit: request.limit,\n\t});\n\n\ttry {\n\t\t// Step 1: Execute AI Search query (Epic 3 Story 3.2)\n\t\t// searchCode handles retry logic, throws ServiceError on failure\n\t\tconst aiSearchStartTime = Date.now();\n\t\tconst aiResults = await searchCode(env, request.query, request.limit);\n\t\tconst aiSearchDuration = Date.now() - aiSearchStartTime;\n\n\t\tlogger.info(\"AI Search completed\", {\n\t\t\tduration: aiSearchDuration,\n\t\t\tresultCount: aiResults.length,\n\t\t});\n\n\t\t// Warn if AI Search is slow (>800ms threshold from Story 3.4)\n\t\tif (aiSearchDuration > 800) {\n\t\t\tlogger.warn(\"Slow AI Search query detected\", {\n\t\t\t\tduration: aiSearchDuration,\n\t\t\t\tthreshold: 800,\n\t\t\t\tquery: request.query.substring(0, 100),\n\t\t\t});\n\t\t}\n\n\t\t// Step 2: Handle empty results gracefully (AC #4)\n\t\tif (aiResults.length === 0) {\n\t\t\tconst emptyDuration = Date.now() - startTime;\n\t\t\tlogger.info(\"No results found for query\", {\n\t\t\t\tduration: emptyDuration,\n\t\t\t\tquery: request.query.substring(0, 100),\n\t\t\t});\n\n\t\t\t// Track empty result for observability metrics (Story 6.3)\n\t\t\tif (metricsCollector) {\n\t\t\t\ttrackQueryResult(metricsCollector, 0, logger);\n\t\t\t\ttrackQueryDuration(metricsCollector, emptyDuration, logger);\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tresults: [],\n\t\t\t\ttook_ms: emptyDuration,\n\t\t\t};\n\t\t}\n\n\t\t// Step 3: Enrich results with metadata (Epic 3 Story 3.3)\n\t\tconst enrichStartTime = Date.now();\n\t\tconst enrichedResults = await enrichResults(env, aiResults);\n\t\tconst enrichDuration = Date.now() - enrichStartTime;\n\n\t\tlogger.info(\"Result enrichment completed\", {\n\t\t\tduration: enrichDuration,\n\t\t\tresultCount: enrichedResults.length,\n\t\t});\n\n\t\t// Step 4: Map enriched results to MCP SearchResult format\n\t\tconst mappedResults = enrichedResults.map((enriched) => mapToSearchResult(enriched));\n\n\t\t// Step 5: Build MCPResponse with total timing\n\t\tconst totalDuration = Date.now() - startTime;\n\n\t\tlogger.info(\"Search request completed\", {\n\t\t\tduration: totalDuration,\n\t\t\tresultCount: mappedResults.length,\n\t\t\taiSearchDuration,\n\t\t\tenrichDuration,\n\t\t});\n\n\t\t// Track custom metrics for observability (Story 6.3)\n\t\tif (metricsCollector) {\n\t\t\ttrackQueryResult(metricsCollector, mappedResults.length, logger);\n\t\t\ttrackQueryDuration(metricsCollector, totalDuration, logger);\n\t\t}\n\n\t\t// Warn if total response time exceeds 2s target (NFR-1.1 from tech spec)\n\t\tif (totalDuration > 2000) {\n\t\t\tlogger.warn(\"Search request exceeded performance target\", {\n\t\t\t\tduration: totalDuration,\n\t\t\t\ttarget: 2000,\n\t\t\t\tquery: request.query.substring(0, 100),\n\t\t\t});\n\t\t}\n\n\t\treturn {\n\t\t\tresults: mappedResults,\n\t\t\ttook_ms: totalDuration,\n\t\t};\n\t} catch (error) {\n\t\tconst errorDuration = Date.now() - startTime;\n\n\t\t// Log error with context\n\t\tlogger.error(\"Search request failed\", {\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t\tduration: errorDuration,\n\t\t\tquery: request.query.substring(0, 100),\n\t\t});\n\n\t\t// Track error by type for observability metrics (Story 6.3)\n\t\tif (metricsCollector) {\n\t\t\tconst errorType =\n\t\t\t\terror instanceof ServiceError ? error.code : error instanceof Error ? error.name : \"UNKNOWN_ERROR\";\n\t\t\ttrackError(metricsCollector, errorType, logger);\n\t\t}\n\n\t\t// ServiceError from searchCode (AI Search timeout/failure) should propagate\n\t\t// formatErrorResponse() in mcp-handler will map it to 503 with retry_after\n\t\tif (error instanceof ServiceError) {\n\t\t\tthrow error;\n\t\t}\n\n\t\t// Unexpected errors become ServiceError for consistent error handling\n\t\tthrow new ServiceError(\"Search service temporarily unavailable\", 503, \"SEARCH_ERROR\", 60);\n\t}\n}\n\n/**\n * Map EnrichedSearchResult to MCP SearchResult format\n *\n * Transforms Epic 3 enrichment format to MCP API response format.\n * Handles field mapping and default values for missing data.\n *\n * @param enriched - Enriched search result from Epic 3 result-enricher\n * @returns SearchResult matching MCP specification\n *\n * Field mappings:\n * - enriched.repository.fullName \u2192 repository\n * - enriched.r2Path \u2192 file_path (parsed from path)\n * - enriched.content \u2192 match_snippet\n * - enriched.score \u2192 relevance_score\n * - enriched.metadata.language \u2192 metadata.language (default: \"Unknown\")\n * - enriched.metadata.pushedAt \u2192 metadata.last_updated\n * - enriched.links.github \u2192 metadata.github_url\n * - stars \u2192 0 (not available in R2 metadata, could add in Phase 2)\n */\nfunction mapToSearchResult(enriched: EnrichedSearchResult): SearchResult {\n\t// Parse file_path from R2 path: \"gitingest/{org}/{repo}/summary.txt\" \u2192 \"summary.txt\"\n\t// For now, use the full R2 path as file_path since gitingest processes entire repos\n\t// Phase 2 could add file-level indexing for more granular results\n\tconst filePath = enriched.r2Path || \"summary.txt\";\n\n\treturn {\n\t\trepository: enriched.repository.fullName,\n\t\tfile_path: filePath,\n\t\tmatch_snippet: enriched.content,\n\t\trelevance_score: enriched.score,\n\t\tmetadata: {\n\t\t\tlanguage: enriched.metadata?.language || \"Unknown\",\n\t\t\tstars: 0, // Not available in R2 metadata (could add from repos.json in Phase 2)\n\t\t\tlast_updated:\n\t\t\t\tenriched.metadata?.pushedAt || enriched.metadata?.processedAt || new Date().toISOString(),\n\t\t\tgithub_url: enriched.links.github,\n\t\t},\n\t};\n}\n", "/**\n * MCP v2 Protocol Handler for govreposcrape\n * Implements request validation, CORS handling, and error formatting\n * for the POST /mcp/search endpoint\n *\n * Follows MCP v2 protocol specification:\n * - JSON request/response format\n * - X-MCP-Version: 2 header\n * - Structured error responses\n * - CORS support for web-based clients\n *\n * @module mcp-handler\n */\n\nimport { createLogger } from \"../utils/logger\";\nimport { ValidationError, ServiceError } from \"../utils/error-handler\";\nimport { executeSearch } from \"./search-endpoint\";\nimport { createMetricsCollector } from \"../utils/metrics\";\nimport type { MCPRequest, ErrorResponse } from \"../types\";\n\n// Validation constants\nconst QUERY_MIN_LENGTH = 3;\nconst QUERY_MAX_LENGTH = 500;\nconst LIMIT_MIN = 1;\nconst LIMIT_MAX = 20;\nconst LIMIT_DEFAULT = 5;\nconst MAX_PAYLOAD_SIZE_KB = 1;\nconst MCP_VERSION = \"2\";\n\n/**\n * MCP error codes following PRD specification\n * Machine-readable codes for client error handling\n */\nexport const ERROR_CODES = {\n\tINVALID_QUERY: \"INVALID_QUERY\",\n\tINVALID_LIMIT: \"INVALID_LIMIT\",\n\tINVALID_CONTENT_TYPE: \"INVALID_CONTENT_TYPE\",\n\tMALFORMED_JSON: \"MALFORMED_JSON\",\n\tPAYLOAD_TOO_LARGE: \"PAYLOAD_TOO_LARGE\",\n\tSEARCH_ERROR: \"SEARCH_ERROR\",\n\tINTERNAL_ERROR: \"INTERNAL_ERROR\",\n} as const;\n\n/**\n * Validates MCP v2 request and returns parsed MCPRequest\n *\n * Validation rules:\n * - Content-Type must be application/json\n * - Request payload must be <1KB\n * - query: required, 3-500 characters (trimmed), UTF-8 string\n * - limit: optional, integer 1-20 (default 5)\n * - X-MCP-Version: warn if not \"2\" but continue\n *\n * @param request - HTTP Request object\n * @returns Validated MCPRequest with trimmed query and default limit\n * @throws ValidationError if validation fails with appropriate error code\n *\n * @example\n * ```typescript\n * const mcpRequest = await validateMCPRequest(request);\n * // mcpRequest = { query: \"authentication methods\", limit: 5 }\n * ```\n */\nexport async function validateMCPRequest(request: Request): Promise<MCPRequest> {\n\tconst logger = createLogger({ operation: \"validate_mcp_request\" });\n\n\t// Validate Content-Type header\n\tconst contentType = request.headers.get(\"content-type\");\n\tif (!contentType || !contentType.includes(\"application/json\")) {\n\t\tthrow new ValidationError(\n\t\t\t\"Content-Type must be application/json\",\n\t\t\tERROR_CODES.INVALID_CONTENT_TYPE,\n\t\t);\n\t}\n\n\t// Check payload size (approximate via Content-Length header)\n\tconst contentLength = request.headers.get(\"content-length\");\n\tif (contentLength && parseInt(contentLength) > MAX_PAYLOAD_SIZE_KB * 1024) {\n\t\tthrow new ValidationError(\n\t\t\t`Request payload must be less than ${MAX_PAYLOAD_SIZE_KB}KB`,\n\t\t\tERROR_CODES.PAYLOAD_TOO_LARGE,\n\t\t);\n\t}\n\n\t// Parse JSON body with error handling\n\tlet body: unknown;\n\ttry {\n\t\tbody = await request.json();\n\t} catch {\n\t\tthrow new ValidationError(\"Request body must be valid JSON\", ERROR_CODES.MALFORMED_JSON);\n\t}\n\n\t// Type guard for body structure\n\tif (typeof body !== \"object\" || body === null) {\n\t\tthrow new ValidationError(\"Request body must be a JSON object\", ERROR_CODES.MALFORMED_JSON);\n\t}\n\n\tconst requestBody = body as Record<string, unknown>;\n\n\t// Validate query field\n\tif (!requestBody.query || typeof requestBody.query !== \"string\") {\n\t\tthrow new ValidationError(\n\t\t\t\"Query field is required and must be a string\",\n\t\t\tERROR_CODES.INVALID_QUERY,\n\t\t);\n\t}\n\n\tconst trimmedQuery = requestBody.query.trim();\n\tif (trimmedQuery.length < QUERY_MIN_LENGTH) {\n\t\tthrow new ValidationError(\n\t\t\t`Query must be at least ${QUERY_MIN_LENGTH} characters`,\n\t\t\tERROR_CODES.INVALID_QUERY,\n\t\t);\n\t}\n\n\tif (trimmedQuery.length > QUERY_MAX_LENGTH) {\n\t\tthrow new ValidationError(\n\t\t\t`Query must be at most ${QUERY_MAX_LENGTH} characters`,\n\t\t\tERROR_CODES.INVALID_QUERY,\n\t\t);\n\t}\n\n\t// Validate limit field (optional)\n\tlet limit = LIMIT_DEFAULT;\n\tif (requestBody.limit !== undefined) {\n\t\tconst limitValue = requestBody.limit;\n\t\tif (typeof limitValue !== \"number\" || !Number.isInteger(limitValue)) {\n\t\t\tthrow new ValidationError(\"Limit must be an integer\", ERROR_CODES.INVALID_LIMIT);\n\t\t}\n\n\t\tif (limitValue < LIMIT_MIN || limitValue > LIMIT_MAX) {\n\t\t\tthrow new ValidationError(\n\t\t\t\t`Limit must be between ${LIMIT_MIN} and ${LIMIT_MAX}`,\n\t\t\t\tERROR_CODES.INVALID_LIMIT,\n\t\t\t);\n\t\t}\n\n\t\tlimit = limitValue;\n\t}\n\n\t// Validate X-MCP-Version header (warn if missing/incorrect, but continue)\n\tconst mcpVersion = request.headers.get(\"x-mcp-version\");\n\tif (mcpVersion !== MCP_VERSION) {\n\t\tlogger.warn(\"MCP version mismatch or missing\", {\n\t\t\texpected: MCP_VERSION,\n\t\t\treceived: mcpVersion || \"none\",\n\t\t});\n\t}\n\n\treturn {\n\t\tquery: trimmedQuery,\n\t\tlimit,\n\t};\n}\n\n/**\n * Adds CORS headers to response for MCP clients\n *\n * CORS configuration:\n * - Access-Control-Allow-Origin: * (open access per ADR-002)\n * - Access-Control-Allow-Methods: POST, OPTIONS, GET\n * - Access-Control-Allow-Headers: Content-Type, X-MCP-Version, X-Request-ID\n *\n * @param response - Response object to add headers to\n * @returns Response with CORS headers added\n *\n * @example\n * ```typescript\n * const response = new Response(JSON.stringify({ results: [] }));\n * return addCORSHeaders(response);\n * ```\n */\nexport function addCORSHeaders(response: Response): Response {\n\tconst headers = new Headers(response.headers);\n\theaders.set(\"Access-Control-Allow-Origin\", \"*\");\n\theaders.set(\"Access-Control-Allow-Methods\", \"POST, OPTIONS, GET\");\n\theaders.set(\"Access-Control-Allow-Headers\", \"Content-Type, X-MCP-Version, X-Request-ID\");\n\n\treturn new Response(response.body, {\n\t\tstatus: response.status,\n\t\tstatusText: response.statusText,\n\t\theaders,\n\t});\n}\n\n/**\n * Handles OPTIONS preflight requests for CORS\n *\n * Returns 204 No Content with appropriate CORS headers\n * Allows web-based MCP clients to make cross-origin requests\n *\n * @returns 204 No Content response with CORS headers\n *\n * @example\n * ```typescript\n * if (request.method === 'OPTIONS') {\n *   return handleOPTIONS();\n * }\n * ```\n */\nexport function handleOPTIONS(): Response {\n\treturn addCORSHeaders(\n\t\tnew Response(null, {\n\t\t\tstatus: 204,\n\t\t\theaders: {\n\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t},\n\t\t}),\n\t);\n}\n\n/**\n * Formats error as MCP-compliant ErrorResponse JSON\n *\n * Maps error types to appropriate HTTP status codes:\n * - ValidationError \u2192 400 Bad Request\n * - ServiceError \u2192 500/503 (from error.statusCode)\n * - Other errors \u2192 500 Internal Server Error\n *\n * All errors return structured JSON in PRD FR-3 format:\n * { error: { code, message, retry_after? } }\n *\n * @param error - Error object (ValidationError, ServiceError, or generic Error)\n * @returns Response with formatted error JSON and appropriate status code\n *\n * @example\n * ```typescript\n * try {\n *   await validateMCPRequest(request);\n * } catch (error) {\n *   return formatErrorResponse(error);\n * }\n * ```\n */\nexport function formatErrorResponse(error: unknown): Response {\n\tconst logger = createLogger({ operation: \"format_error_response\" });\n\n\tlet statusCode = 500;\n\tlet errorResponse: ErrorResponse;\n\n\tif (error instanceof ValidationError) {\n\t\tstatusCode = 400;\n\t\terrorResponse = {\n\t\t\terror: {\n\t\t\t\tcode: error.code,\n\t\t\t\tmessage: error.message,\n\t\t\t},\n\t\t};\n\t} else if (error instanceof ServiceError) {\n\t\tstatusCode = error.statusCode;\n\t\terrorResponse = {\n\t\t\terror: {\n\t\t\t\tcode: error.code,\n\t\t\t\tmessage: error.message,\n\t\t\t\tretry_after: error.retryAfter,\n\t\t\t},\n\t\t};\n\t} else {\n\t\t// Unhandled exception - log details but return generic message\n\t\tconst errorMessage = error instanceof Error ? error.message : \"Unknown error\";\n\t\tconst errorStack = error instanceof Error ? error.stack : undefined;\n\t\tlogger.error(\"Unhandled exception\", {\n\t\t\terror: errorMessage,\n\t\t\tstack: errorStack,\n\t\t});\n\n\t\terrorResponse = {\n\t\t\terror: {\n\t\t\t\tcode: ERROR_CODES.INTERNAL_ERROR,\n\t\t\t\tmessage: \"An unexpected error occurred\",\n\t\t\t},\n\t\t};\n\t}\n\n\treturn addCORSHeaders(\n\t\tnew Response(JSON.stringify(errorResponse), {\n\t\t\tstatus: statusCode,\n\t\t\theaders: {\n\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t},\n\t\t}),\n\t);\n}\n\n/**\n * Handles POST /mcp/search requests with MCP v2 protocol\n *\n * Request flow:\n * 1. Extract/generate X-Request-ID for correlation\n * 2. Validate MCP request (query, limit, headers)\n * 3. Execute semantic search via executeSearch() (Story 4.2)\n * 4. Log request with structured JSON (requestId, duration, resultCount)\n *\n * Response includes:\n * - X-MCP-Version: 2 header\n * - X-Request-ID: correlation UUID\n * - CORS headers\n * - JSON body: { results: SearchResult[], took_ms: number }\n *\n * @param request - HTTP Request object\n * @param env - Workers environment bindings (AI_SEARCH, R2 for search and enrichment)\n * @returns MCPResponse JSON (200 OK) or ErrorResponse JSON (400/500/503)\n *\n * @example\n * ```bash\n * # Valid request\n * curl -X POST http://localhost:8787/mcp/search \\\n *   -H \"Content-Type: application/json\" \\\n *   -H \"X-MCP-Version: 2\" \\\n *   -d '{\"query\":\"authentication methods\",\"limit\":5}'\n *\n * # Invalid request (query too short)\n * curl -X POST http://localhost:8787/mcp/search \\\n *   -H \"Content-Type: application/json\" \\\n *   -d '{\"query\":\"ab\"}'\n * # Returns: 400 Bad Request with INVALID_QUERY error code\n *\n * # OPTIONS preflight\n * curl -X OPTIONS http://localhost:8787/mcp/search\n * # Returns: 204 No Content with CORS headers\n * ```\n */\nexport async function handleMCPSearch(request: Request, env: Env): Promise<Response> {\n\t// Generate or extract request ID for correlation\n\tconst requestId = request.headers.get(\"x-request-id\") || crypto.randomUUID();\n\tconst startTime = Date.now();\n\tconst logger = createLogger({ operation: \"mcp_search\", requestId });\n\n\ttry {\n\t\t// Validate MCP request\n\t\tconst mcpRequest = await validateMCPRequest(request);\n\t\tlogger.info(\"MCP request validated\", {\n\t\t\tquery: mcpRequest.query.substring(0, 100), // Truncate for privacy\n\t\t\tlimit: mcpRequest.limit,\n\t\t});\n\n\t\t// Execute semantic search (Story 4.2)\n\t\t// executeSearch orchestrates: AI Search \u2192 enrichment \u2192 MCP format mapping\n\t\t// Create metrics collector for custom metrics tracking (Story 6.3)\n\t\tconst metricsCollector = createMetricsCollector();\n\t\tconst mcpResponse = await executeSearch(mcpRequest, env, metricsCollector);\n\n\t\t// Log request completion\n\t\tconst duration = Date.now() - startTime;\n\t\tlogger.info(\"MCP search completed\", {\n\t\t\tduration,\n\t\t\tresultCount: mcpResponse.results.length,\n\t\t\tstatusCode: 200,\n\t\t});\n\n\t\treturn addCORSHeaders(\n\t\t\tnew Response(JSON.stringify(mcpResponse), {\n\t\t\t\tstatus: 200,\n\t\t\t\theaders: {\n\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\t\"X-MCP-Version\": MCP_VERSION,\n\t\t\t\t\t\"X-Request-ID\": requestId,\n\t\t\t\t},\n\t\t\t}),\n\t\t);\n\t} catch (error) {\n\t\t// Log error with duration\n\t\tlogger.error(\"MCP search failed\", {\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t\tduration: Date.now() - startTime,\n\t\t});\n\n\t\treturn formatErrorResponse(error);\n\t}\n}\n", "{\n  \"openapi\": \"3.0.3\",\n  \"info\": {\n    \"title\": \"govscraperepo MCP API\",\n    \"description\": \"Semantic search API for discovering code patterns and implementations across UK government repositories. This API provides MCP v2 protocol-compliant endpoints for searching through indexed government code repositories using natural language queries. Powered by Cloudflare AI Search for intelligent, context-aware code discovery.\",\n    \"version\": \"1.0.0\",\n    \"contact\": {\n      \"name\": \"GitHub Issues\",\n      \"url\": \"https://github.com/chrisns/govreposcrape/issues\"\n    },\n    \"license\": {\n      \"name\": \"MIT\",\n      \"url\": \"https://opensource.org/licenses/MIT\"\n    }\n  },\n  \"servers\": [\n    {\n      \"url\": \"https://govreposcrape.cloud.cns.me\",\n      \"description\": \"Production API server\"\n    }\n  ],\n  \"security\": [],\n  \"paths\": {\n    \"/mcp/search\": {\n      \"post\": {\n        \"summary\": \"Semantic code search\",\n        \"description\": \"Execute a semantic search query across indexed UK government repositories. Returns relevant code snippets ranked by similarity score. Supports natural language queries for discovering code patterns, implementations, and examples.\",\n        \"operationId\": \"searchCode\",\n        \"tags\": [\"MCP API\"],\n        \"parameters\": [\n          {\n            \"name\": \"X-MCP-Version\",\n            \"in\": \"header\",\n            \"description\": \"MCP protocol version (optional but recommended)\",\n            \"required\": false,\n            \"schema\": {\n              \"type\": \"string\",\n              \"example\": \"2\"\n            }\n          },\n          {\n            \"name\": \"X-Request-ID\",\n            \"in\": \"header\",\n            \"description\": \"Client-provided request correlation ID (optional)\",\n            \"required\": false,\n            \"schema\": {\n              \"type\": \"string\",\n              \"format\": \"uuid\"\n            }\n          }\n        ],\n        \"requestBody\": {\n          \"required\": true,\n          \"content\": {\n            \"application/json\": {\n              \"schema\": {\n                \"$ref\": \"#/components/schemas/MCPRequest\"\n              },\n              \"examples\": {\n                \"authentication\": {\n                  \"summary\": \"Search for authentication implementations\",\n                  \"value\": {\n                    \"query\": \"authentication middleware JWT token validation\",\n                    \"limit\": 5\n                  }\n                },\n                \"api_endpoints\": {\n                  \"summary\": \"Search for API endpoint patterns\",\n                  \"value\": {\n                    \"query\": \"REST API endpoint handler Express routes\",\n                    \"limit\": 10\n                  }\n                },\n                \"data_validation\": {\n                  \"summary\": \"Search for data validation examples\",\n                  \"value\": {\n                    \"query\": \"form validation schema Zod TypeScript\"\n                  }\n                }\n              }\n            }\n          }\n        },\n        \"responses\": {\n          \"200\": {\n            \"description\": \"Successful search with results\",\n            \"headers\": {\n              \"X-MCP-Version\": {\n                \"schema\": {\n                  \"type\": \"string\",\n                  \"example\": \"2\"\n                },\n                \"description\": \"MCP protocol version\"\n              },\n              \"X-Request-ID\": {\n                \"schema\": {\n                  \"type\": \"string\",\n                  \"format\": \"uuid\"\n                },\n                \"description\": \"Request correlation ID\"\n              },\n              \"Access-Control-Allow-Origin\": {\n                \"schema\": {\n                  \"type\": \"string\",\n                  \"example\": \"*\"\n                },\n                \"description\": \"CORS header for cross-origin requests\"\n              }\n            },\n            \"content\": {\n              \"application/json\": {\n                \"schema\": {\n                  \"$ref\": \"#/components/schemas/MCPResponse\"\n                },\n                \"examples\": {\n                  \"success_with_results\": {\n                    \"summary\": \"Successful search with 5 results\",\n                    \"value\": {\n                      \"results\": [\n                        {\n                          \"repository\": \"alphagov/govuk-frontend\",\n                          \"file_path\": \"src/auth/middleware/jwt-validator.ts\",\n                          \"match_snippet\": \"export function validateJWT(token: string): boolean {\\n  const decoded = jwt.verify(token, process.env.JWT_SECRET);\\n  return decoded.exp > Date.now();\\n}\",\n                          \"relevance_score\": 0.92,\n                          \"metadata\": {\n                            \"language\": \"TypeScript\",\n                            \"stars\": 1250,\n                            \"last_updated\": \"2025-11-10T14:30:00Z\",\n                            \"github_url\": \"https://github.com/alphagov/govuk-frontend\"\n                          }\n                        },\n                        {\n                          \"repository\": \"ministryofjustice/cloud-platform\",\n                          \"file_path\": \"lib/auth/token-handler.js\",\n                          \"match_snippet\": \"class TokenHandler {\\n  validateToken(req, res, next) {\\n    const token = req.headers.authorization?.split(' ')[1];\\n    if (!token) return res.status(401).json({ error: 'No token provided' });\\n    // Verify JWT token\\n  }\\n}\",\n                          \"relevance_score\": 0.87,\n                          \"metadata\": {\n                            \"language\": \"JavaScript\",\n                            \"stars\": 890,\n                            \"last_updated\": \"2025-11-09T10:15:00Z\",\n                            \"github_url\": \"https://github.com/ministryofjustice/cloud-platform\"\n                          }\n                        },\n                        {\n                          \"repository\": \"nhsconnect/prm-deductions\",\n                          \"file_path\": \"src/middleware/auth.ts\",\n                          \"match_snippet\": \"async function authenticateRequest(req: Request): Promise<User> {\\n  const authHeader = req.headers.get('Authorization');\\n  const token = extractToken(authHeader);\\n  return await verifyJWT(token);\\n}\",\n                          \"relevance_score\": 0.84,\n                          \"metadata\": {\n                            \"language\": \"TypeScript\",\n                            \"stars\": 450,\n                            \"last_updated\": \"2025-11-08T16:45:00Z\",\n                            \"github_url\": \"https://github.com/nhsconnect/prm-deductions\"\n                          }\n                        },\n                        {\n                          \"repository\": \"defra/water-abstraction-service\",\n                          \"file_path\": \"server/auth/jwt-strategy.js\",\n                          \"match_snippet\": \"const JWTStrategy = require('passport-jwt').Strategy;\\nconst opts = {\\n  jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),\\n  secretOrKey: config.jwt.secret\\n};\",\n                          \"relevance_score\": 0.79,\n                          \"metadata\": {\n                            \"language\": \"JavaScript\",\n                            \"stars\": 320,\n                            \"last_updated\": \"2025-11-07T12:00:00Z\",\n                            \"github_url\": \"https://github.com/defra/water-abstraction-service\"\n                          }\n                        },\n                        {\n                          \"repository\": \"DFE-Digital/login.dfe.public-api\",\n                          \"file_path\": \"src/app/utils/jwtAuth.js\",\n                          \"match_snippet\": \"const validateJwtToken = (token) => {\\n  try {\\n    const decoded = jwt.verify(token, config.auth.jwtSecret);\\n    return { valid: true, userId: decoded.sub };\\n  } catch (err) {\\n    return { valid: false, error: err.message };\\n  }\\n};\",\n                          \"relevance_score\": 0.75,\n                          \"metadata\": {\n                            \"language\": \"JavaScript\",\n                            \"stars\": 180,\n                            \"last_updated\": \"2025-11-06T09:30:00Z\",\n                            \"github_url\": \"https://github.com/DFE-Digital/login.dfe.public-api\"\n                          }\n                        }\n                      ],\n                      \"took_ms\": 245\n                    }\n                  },\n                  \"no_results\": {\n                    \"summary\": \"Successful search with no results\",\n                    \"value\": {\n                      \"results\": [],\n                      \"took_ms\": 120\n                    }\n                  }\n                }\n              }\n            }\n          },\n          \"400\": {\n            \"description\": \"Bad request - invalid query parameters\",\n            \"content\": {\n              \"application/json\": {\n                \"schema\": {\n                  \"$ref\": \"#/components/schemas/ErrorResponse\"\n                },\n                \"examples\": {\n                  \"query_too_short\": {\n                    \"summary\": \"Query below minimum length\",\n                    \"value\": {\n                      \"error\": {\n                        \"code\": \"INVALID_QUERY\",\n                        \"message\": \"Query must be at least 3 characters\"\n                      }\n                    }\n                  },\n                  \"query_too_long\": {\n                    \"summary\": \"Query exceeds maximum length\",\n                    \"value\": {\n                      \"error\": {\n                        \"code\": \"INVALID_QUERY\",\n                        \"message\": \"Query must be at most 500 characters\"\n                      }\n                    }\n                  },\n                  \"invalid_limit\": {\n                    \"summary\": \"Limit out of range\",\n                    \"value\": {\n                      \"error\": {\n                        \"code\": \"INVALID_LIMIT\",\n                        \"message\": \"Limit must be between 1 and 20\"\n                      }\n                    }\n                  },\n                  \"invalid_content_type\": {\n                    \"summary\": \"Wrong Content-Type header\",\n                    \"value\": {\n                      \"error\": {\n                        \"code\": \"INVALID_CONTENT_TYPE\",\n                        \"message\": \"Content-Type must be application/json\"\n                      }\n                    }\n                  },\n                  \"malformed_json\": {\n                    \"summary\": \"Invalid JSON in request body\",\n                    \"value\": {\n                      \"error\": {\n                        \"code\": \"MALFORMED_JSON\",\n                        \"message\": \"Request body must be valid JSON\"\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          },\n          \"500\": {\n            \"description\": \"Internal server error\",\n            \"content\": {\n              \"application/json\": {\n                \"schema\": {\n                  \"$ref\": \"#/components/schemas/ErrorResponse\"\n                },\n                \"examples\": {\n                  \"internal_error\": {\n                    \"summary\": \"Unexpected internal error\",\n                    \"value\": {\n                      \"error\": {\n                        \"code\": \"INTERNAL_ERROR\",\n                        \"message\": \"An unexpected error occurred\"\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          },\n          \"503\": {\n            \"description\": \"Service unavailable - search service temporarily unavailable\",\n            \"content\": {\n              \"application/json\": {\n                \"schema\": {\n                  \"$ref\": \"#/components/schemas/ErrorResponse\"\n                },\n                \"examples\": {\n                  \"search_service_down\": {\n                    \"summary\": \"AI Search service unavailable\",\n                    \"value\": {\n                      \"error\": {\n                        \"code\": \"SEARCH_ERROR\",\n                        \"message\": \"Search service is temporarily unavailable\",\n                        \"retry_after\": 60\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    },\n    \"/mcp/health\": {\n      \"get\": {\n        \"summary\": \"Health check\",\n        \"description\": \"Check the health status of all service dependencies (KV, R2, Vectorize, D1, AI Search). Returns 200 OK when all services are accessible, 503 Service Unavailable when any service fails.\",\n        \"operationId\": \"checkHealth\",\n        \"tags\": [\"MCP API\"],\n        \"responses\": {\n          \"200\": {\n            \"description\": \"All services healthy\",\n            \"content\": {\n              \"application/json\": {\n                \"schema\": {\n                  \"$ref\": \"#/components/schemas/HealthCheckResponse\"\n                },\n                \"examples\": {\n                  \"all_healthy\": {\n                    \"summary\": \"All services operational\",\n                    \"value\": {\n                      \"status\": \"healthy\",\n                      \"services\": {\n                        \"kv\": {\n                          \"name\": \"KV Namespace\",\n                          \"status\": \"ok\"\n                        },\n                        \"r2\": {\n                          \"name\": \"R2 Bucket\",\n                          \"status\": \"ok\"\n                        },\n                        \"vectorize\": {\n                          \"name\": \"Vectorize Index\",\n                          \"status\": \"ok\"\n                        },\n                        \"d1\": {\n                          \"name\": \"D1 Database\",\n                          \"status\": \"ok\"\n                        },\n                        \"ai_search\": {\n                          \"name\": \"AI Search\",\n                          \"status\": \"ok\"\n                        }\n                      },\n                      \"timestamp\": \"2025-11-14T10:30:00.000Z\"\n                    }\n                  }\n                }\n              }\n            }\n          },\n          \"503\": {\n            \"description\": \"One or more services unhealthy\",\n            \"content\": {\n              \"application/json\": {\n                \"schema\": {\n                  \"type\": \"object\",\n                  \"properties\": {\n                    \"error\": {\n                      \"type\": \"object\",\n                      \"properties\": {\n                        \"code\": {\n                          \"type\": \"string\",\n                          \"example\": \"SERVICE_UNAVAILABLE\"\n                        },\n                        \"message\": {\n                          \"type\": \"string\",\n                          \"example\": \"One or more services are unavailable\"\n                        }\n                      },\n                      \"required\": [\"code\", \"message\"]\n                    },\n                    \"details\": {\n                      \"$ref\": \"#/components/schemas/HealthCheckResponse\"\n                    }\n                  },\n                  \"required\": [\"error\", \"details\"]\n                },\n                \"examples\": {\n                  \"ai_search_down\": {\n                    \"summary\": \"AI Search service failure\",\n                    \"value\": {\n                      \"error\": {\n                        \"code\": \"SERVICE_UNAVAILABLE\",\n                        \"message\": \"One or more services are unavailable\"\n                      },\n                      \"details\": {\n                        \"status\": \"unhealthy\",\n                        \"services\": {\n                          \"kv\": {\n                            \"name\": \"KV Namespace\",\n                            \"status\": \"ok\"\n                          },\n                          \"r2\": {\n                            \"name\": \"R2 Bucket\",\n                            \"status\": \"ok\"\n                          },\n                          \"vectorize\": {\n                            \"name\": \"Vectorize Index\",\n                            \"status\": \"ok\"\n                          },\n                          \"d1\": {\n                            \"name\": \"D1 Database\",\n                            \"status\": \"ok\"\n                          },\n                          \"ai_search\": {\n                            \"name\": \"AI Search\",\n                            \"status\": \"failed\",\n                            \"error\": \"Connection timeout\"\n                          }\n                        },\n                        \"timestamp\": \"2025-11-14T10:30:00.000Z\"\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  },\n  \"components\": {\n    \"schemas\": {\n      \"MCPRequest\": {\n        \"type\": \"object\",\n        \"description\": \"MCP v2 search request payload\",\n        \"required\": [\"query\"],\n        \"properties\": {\n          \"query\": {\n            \"type\": \"string\",\n            \"description\": \"Natural language search query (3-500 characters). Use descriptive phrases to find relevant code patterns, implementations, or examples.\",\n            \"minLength\": 3,\n            \"maxLength\": 500,\n            \"example\": \"authentication middleware JWT token validation\"\n          },\n          \"limit\": {\n            \"type\": \"integer\",\n            \"description\": \"Maximum number of results to return (1-20). Defaults to 5 if not specified.\",\n            \"minimum\": 1,\n            \"maximum\": 20,\n            \"default\": 5,\n            \"example\": 10\n          }\n        }\n      },\n      \"MCPResponse\": {\n        \"type\": \"object\",\n        \"description\": \"MCP v2 search response with results and performance metrics\",\n        \"required\": [\"results\", \"took_ms\"],\n        \"properties\": {\n          \"results\": {\n            \"type\": \"array\",\n            \"description\": \"Array of search results ranked by relevance score (highest first). May be empty if no matches found.\",\n            \"items\": {\n              \"$ref\": \"#/components/schemas/SearchResult\"\n            }\n          },\n          \"took_ms\": {\n            \"type\": \"number\",\n            \"description\": \"Query execution time in milliseconds\",\n            \"example\": 245\n          }\n        }\n      },\n      \"SearchResult\": {\n        \"type\": \"object\",\n        \"description\": \"A single search result with code snippet and repository metadata\",\n        \"required\": [\n          \"repository\",\n          \"file_path\",\n          \"match_snippet\",\n          \"relevance_score\",\n          \"metadata\"\n        ],\n        \"properties\": {\n          \"repository\": {\n            \"type\": \"string\",\n            \"description\": \"Repository identifier in 'org/repo' format\",\n            \"example\": \"alphagov/govuk-frontend\"\n          },\n          \"file_path\": {\n            \"type\": \"string\",\n            \"description\": \"Path to the file within the repository\",\n            \"example\": \"src/auth/middleware/jwt-validator.ts\"\n          },\n          \"match_snippet\": {\n            \"type\": \"string\",\n            \"description\": \"Code snippet matching the search query (may be truncated for brevity)\",\n            \"example\": \"export function validateJWT(token: string): boolean {\\n  const decoded = jwt.verify(token, process.env.JWT_SECRET);\\n  return decoded.exp > Date.now();\\n}\"\n          },\n          \"relevance_score\": {\n            \"type\": \"number\",\n            \"description\": \"Semantic similarity score (0.0-1.0) indicating relevance to query. Higher scores indicate better matches.\",\n            \"minimum\": 0.0,\n            \"maximum\": 1.0,\n            \"example\": 0.92\n          },\n          \"metadata\": {\n            \"type\": \"object\",\n            \"description\": \"Additional repository and result metadata\",\n            \"required\": [\"language\", \"stars\", \"last_updated\", \"github_url\"],\n            \"properties\": {\n              \"language\": {\n                \"type\": \"string\",\n                \"description\": \"Primary programming language of the file\",\n                \"example\": \"TypeScript\"\n              },\n              \"stars\": {\n                \"type\": \"integer\",\n                \"description\": \"GitHub star count for the repository\",\n                \"example\": 1250\n              },\n              \"last_updated\": {\n                \"type\": \"string\",\n                \"format\": \"date-time\",\n                \"description\": \"Last update timestamp (ISO 8601 format)\",\n                \"example\": \"2025-11-10T14:30:00Z\"\n              },\n              \"github_url\": {\n                \"type\": \"string\",\n                \"format\": \"uri\",\n                \"description\": \"Direct link to the GitHub repository\",\n                \"example\": \"https://github.com/alphagov/govuk-frontend\"\n              }\n            }\n          }\n        }\n      },\n      \"HealthCheckResponse\": {\n        \"type\": \"object\",\n        \"description\": \"Health check response showing status of all service dependencies\",\n        \"required\": [\"status\", \"services\", \"timestamp\"],\n        \"properties\": {\n          \"status\": {\n            \"type\": \"string\",\n            \"description\": \"Overall health status: 'healthy' when all services ok, 'unhealthy' when any service fails\",\n            \"enum\": [\"healthy\", \"unhealthy\"],\n            \"example\": \"healthy\"\n          },\n          \"services\": {\n            \"type\": \"object\",\n            \"description\": \"Individual service health statuses\",\n            \"additionalProperties\": {\n              \"$ref\": \"#/components/schemas/ServiceStatus\"\n            },\n            \"example\": {\n              \"kv\": {\n                \"name\": \"KV Namespace\",\n                \"status\": \"ok\"\n              },\n              \"r2\": {\n                \"name\": \"R2 Bucket\",\n                \"status\": \"ok\"\n              },\n              \"vectorize\": {\n                \"name\": \"Vectorize Index\",\n                \"status\": \"ok\"\n              },\n              \"d1\": {\n                \"name\": \"D1 Database\",\n                \"status\": \"ok\"\n              },\n              \"ai_search\": {\n                \"name\": \"AI Search\",\n                \"status\": \"ok\"\n              }\n            }\n          },\n          \"timestamp\": {\n            \"type\": \"string\",\n            \"format\": \"date-time\",\n            \"description\": \"Health check execution time (ISO 8601 format)\",\n            \"example\": \"2025-11-14T10:30:00.000Z\"\n          }\n        }\n      },\n      \"ServiceStatus\": {\n        \"type\": \"object\",\n        \"description\": \"Health status for a single service\",\n        \"required\": [\"name\", \"status\"],\n        \"properties\": {\n          \"name\": {\n            \"type\": \"string\",\n            \"description\": \"Human-readable service name\",\n            \"example\": \"AI Search\"\n          },\n          \"status\": {\n            \"type\": \"string\",\n            \"description\": \"Service connection status\",\n            \"enum\": [\"ok\", \"failed\"],\n            \"example\": \"ok\"\n          },\n          \"error\": {\n            \"type\": \"string\",\n            \"description\": \"Error message if service status is 'failed' (optional)\",\n            \"example\": \"Connection timeout\"\n          }\n        }\n      },\n      \"ErrorResponse\": {\n        \"type\": \"object\",\n        \"description\": \"Structured error response for all API errors\",\n        \"required\": [\"error\"],\n        \"properties\": {\n          \"error\": {\n            \"type\": \"object\",\n            \"description\": \"Error details with machine-readable code and human-readable message\",\n            \"required\": [\"code\", \"message\"],\n            \"properties\": {\n              \"code\": {\n                \"type\": \"string\",\n                \"description\": \"Machine-readable error code for programmatic handling\",\n                \"enum\": [\n                  \"INVALID_QUERY\",\n                  \"INVALID_LIMIT\",\n                  \"INVALID_CONTENT_TYPE\",\n                  \"MALFORMED_JSON\",\n                  \"PAYLOAD_TOO_LARGE\",\n                  \"SEARCH_ERROR\",\n                  \"INTERNAL_ERROR\",\n                  \"SERVICE_UNAVAILABLE\"\n                ],\n                \"example\": \"INVALID_QUERY\"\n              },\n              \"message\": {\n                \"type\": \"string\",\n                \"description\": \"Human-readable error message explaining what went wrong\",\n                \"example\": \"Query must be at least 3 characters\"\n              },\n              \"retry_after\": {\n                \"type\": \"integer\",\n                \"description\": \"Suggested retry delay in seconds (optional, for rate limiting or service unavailable errors)\",\n                \"example\": 60\n              }\n            }\n          }\n        }\n      }\n    },\n    \"securitySchemes\": {}\n  },\n  \"tags\": [\n    {\n      \"name\": \"MCP API\",\n      \"description\": \"MCP v2 protocol endpoints for semantic code search and health monitoring\"\n    }\n  ],\n  \"externalDocs\": {\n    \"description\": \"Integration guides and documentation\",\n    \"url\": \"https://github.com/chrisns/govreposcrape/blob/main/README.md\"\n  }\n}\n", "/**\n * govreposcrape - Cloudflare Workers application\n * Main entry point for the Workers application\n *\n * Routes:\n * - POST /mcp/search - MCP v2 semantic search endpoint (Epic 4 Story 4.1)\n * - OPTIONS * - CORS preflight handler\n * - GET /health - Health check endpoint for service connectivity validation\n * - GET /mcp/health - MCP API health check (Epic 3 Story 3.1)\n * - GET /openapi.json - OpenAPI 3.0 specification (Epic 5 Story 5.2)\n * - GET /cache/:org/:repo - Cache proxy for Docker containers (Quality Story 1)\n * - PUT /cache/:org/:repo - Cache proxy for Docker containers (Quality Story 1)\n * - GET /cache/stats - Cache statistics (Quality Story 1)\n * - GET / - Welcome message\n */\n\nimport { checkHealth } from \"./api/health\";\nimport { getCacheEntry, putCacheEntry, getCacheStatistics } from \"./api/cache-proxy\";\nimport { handleMCPSearch, handleOPTIONS, formatErrorResponse } from \"./api/mcp-handler\";\nimport { createLogger, type LogLevel } from \"./utils/logger\";\nimport openapiSpec from \"../static/openapi.json\";\n\nexport default {\n\tasync fetch(request: Request, env: Env, ctx: ExecutionContext): Promise<Response> {\n\t\tconst url = new URL(request.url);\n\t\tconst requestId = crypto.randomUUID();\n\t\tconst startTime = Date.now();\n\n\t\t// Create logger with environment-specific log level\n\t\t// LOG_LEVEL from wrangler.jsonc: debug (dev), info (staging/prod)\n\t\tconst logLevel = (env.LOG_LEVEL as LogLevel) || \"debug\";\n\t\tconst logger = createLogger({ operation: \"fetch\", requestId }, logLevel);\n\n\t\t// Log request start\n\t\tlogger.info(\"Request received\", {\n\t\t\tmethod: request.method,\n\t\t\tpath: url.pathname,\n\t\t});\n\n\t\ttry {\n\t\t\tlet response: Response;\n\n\t\t\t// Handle OPTIONS preflight requests for CORS\n\t\t\tif (request.method === \"OPTIONS\") {\n\t\t\t\tresponse = handleOPTIONS();\n\t\t\t}\n\t\t\t// MCP v2 search endpoint (Epic 4 Story 4.1)\n\t\t\telse if (request.method === \"POST\" && url.pathname === \"/mcp/search\") {\n\t\t\t\tresponse = await handleMCPSearch(request, env);\n\t\t\t}\n\t\t\t// Health check endpoints\n\t\t\telse if (\n\t\t\t\t(url.pathname === \"/health\" || url.pathname === \"/mcp/health\") &&\n\t\t\t\trequest.method === \"GET\"\n\t\t\t) {\n\t\t\t\tresponse = await checkHealth(env, requestId);\n\t\t\t}\n\t\t\t// OpenAPI 3.0 specification endpoint (Epic 5 Story 5.2)\n\t\t\telse if (url.pathname === \"/openapi.json\" && request.method === \"GET\") {\n\t\t\t\tresponse = new Response(JSON.stringify(openapiSpec), {\n\t\t\t\t\tstatus: 200,\n\t\t\t\t\theaders: {\n\t\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\t\t\"Access-Control-Allow-Origin\": \"*\",\n\t\t\t\t\t\t\"Access-Control-Allow-Methods\": \"GET, OPTIONS\",\n\t\t\t\t\t\t\"Access-Control-Allow-Headers\": \"Content-Type\",\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t\tlogger.info(\"OpenAPI spec served\", { requestId });\n\t\t\t}\n\t\t\t// Cache proxy endpoints (Quality Story 1)\n\t\t\telse if (url.pathname === \"/cache/stats\" && request.method === \"GET\") {\n\t\t\t\tresponse = await getCacheStatistics(requestId);\n\t\t\t} else if (url.pathname.startsWith(\"/cache/\") && url.pathname !== \"/cache/stats\") {\n\t\t\t\tif (request.method === \"GET\") {\n\t\t\t\t\tresponse = await getCacheEntry(url, env, requestId);\n\t\t\t\t} else if (request.method === \"PUT\") {\n\t\t\t\t\tresponse = await putCacheEntry(url, request, env, requestId);\n\t\t\t\t} else {\n\t\t\t\t\t// Unsupported method for cache endpoints\n\t\t\t\t\tresponse = new Response(\n\t\t\t\t\t\tJSON.stringify({\n\t\t\t\t\t\t\terror: {\n\t\t\t\t\t\t\t\tcode: \"METHOD_NOT_ALLOWED\",\n\t\t\t\t\t\t\t\tmessage: \"Method not allowed for cache endpoints\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}),\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tstatus: 405,\n\t\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\t\t\t\tAllow: \"GET, PUT\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t\t// Default route\n\t\t\telse if (url.pathname === \"/\" && request.method === \"GET\") {\n\t\t\t\tresponse = new Response(\n\t\t\t\t\tJSON.stringify({\n\t\t\t\t\t\tname: \"govreposcrape\",\n\t\t\t\t\t\tversion: \"1.0.0\",\n\t\t\t\t\t\tstatus: \"running\",\n\t\t\t\t\t\tmessage: \"UK Government Code Repository Search - Cloudflare Workers\",\n\t\t\t\t\t\tendpoints: {\n\t\t\t\t\t\t\tmcp_search: \"/mcp/search\",\n\t\t\t\t\t\t\thealth: \"/health\",\n\t\t\t\t\t\t\tmcp_health: \"/mcp/health\",\n\t\t\t\t\t\t\topenapi_spec: \"/openapi.json\",\n\t\t\t\t\t\t\tcache_get: \"/cache/:org/:repo?pushedAt=<timestamp>\",\n\t\t\t\t\t\t\tcache_put: \"/cache/:org/:repo\",\n\t\t\t\t\t\t\tcache_stats: \"/cache/stats\",\n\t\t\t\t\t\t},\n\t\t\t\t\t}),\n\t\t\t\t\t{\n\t\t\t\t\t\tstatus: 200,\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\t// 404 for unknown routes - moved below\n\t\t\t\tresponse = new Response(\n\t\t\t\t\tJSON.stringify({\n\t\t\t\t\t\terror: {\n\t\t\t\t\t\t\tcode: \"NOT_FOUND\",\n\t\t\t\t\t\t\tmessage: \"Route not found\",\n\t\t\t\t\t\t},\n\t\t\t\t\t}),\n\t\t\t\t\t{\n\t\t\t\t\t\tstatus: 404,\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tlogger.warn(\"Route not found\", {\n\t\t\t\t\tpath: url.pathname,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Log request completion with performance monitoring\n\t\t\tconst duration = Date.now() - startTime;\n\n\t\t\t// Warn if request took longer than 2s (NFR-1.1 threshold)\n\t\t\tif (duration > 2000) {\n\t\t\t\tlogger.warn(\"Slow request detected\", {\n\t\t\t\t\tduration,\n\t\t\t\t\tstatusCode: response.status,\n\t\t\t\t\tpath: url.pathname,\n\t\t\t\t\tthreshold: \"2000ms (NFR-1.1)\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tlogger.info(\"Request completed\", {\n\t\t\t\tduration,\n\t\t\t\tstatusCode: response.status,\n\t\t\t\tpath: url.pathname,\n\t\t\t});\n\n\t\t\treturn response;\n\t\t} catch (error) {\n\t\t\t// Global error handler - catches all unhandled errors\n\t\t\tconst duration = Date.now() - startTime;\n\n\t\t\t// Log error with full context\n\t\t\t// NOTE: No sanitizeLogData() needed - this is a public API with no authentication,\n\t\t\t// no user data, and no secrets. All logged fields (requestId, path, method, error)\n\t\t\t// are safe to expose in logs.\n\t\t\tlogger.error(\"Request failed with unhandled error\", {\n\t\t\t\tduration,\n\t\t\t\tpath: url.pathname,\n\t\t\t\tmethod: request.method,\n\t\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t\t\terrorName: error instanceof Error ? error.name : undefined,\n\t\t\t\t// Stack trace filtered in production to avoid exposing internal implementation details\n\t\t\t\t...(env.ENVIRONMENT !== \"production\" &&\n\t\t\t\t\terror instanceof Error && { stack: error.stack }),\n\t\t\t});\n\n\t\t\t// Format error response using Story 4.1 formatErrorResponse\n\t\t\t// This handles ValidationError \u2192 400, ServiceError \u2192 500/503, unknown \u2192 500\n\t\t\tconst errorResponse = formatErrorResponse(error);\n\n\t\t\t// Log response status\n\t\t\tlogger.info(\"Request completed with error\", {\n\t\t\t\tduration,\n\t\t\t\tstatusCode: errorResponse.status,\n\t\t\t});\n\n\t\t\treturn errorResponse;\n\t\t}\n\t},\n} satisfies ExportedHandler<Env>;\n", "import type { Middleware } from \"./common\";\n\nconst drainBody: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} finally {\n\t\ttry {\n\t\t\tif (request.body !== null && !request.bodyUsed) {\n\t\t\t\tconst reader = request.body.getReader();\n\t\t\t\twhile (!(await reader.read()).done) {}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Failed to drain the unused request body.\", e);\n\t\t}\n\t}\n};\n\nexport default drainBody;\n", "import type { Middleware } from \"./common\";\n\ninterface JsonError {\n\tmessage?: string;\n\tname?: string;\n\tstack?: string;\n\tcause?: JsonError;\n}\n\nfunction reduceError(e: any): JsonError {\n\treturn {\n\t\tname: e?.name,\n\t\tmessage: e?.message ?? String(e),\n\t\tstack: e?.stack,\n\t\tcause: e?.cause === undefined ? undefined : reduceError(e.cause),\n\t};\n}\n\n// See comment in `bundle.ts` for details on why this is needed\nconst jsonError: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} catch (e: any) {\n\t\tconst error = reduceError(e);\n\t\treturn Response.json(error, {\n\t\t\tstatus: 500,\n\t\t\theaders: { \"MF-Experimental-Error-Stack\": \"true\" },\n\t\t});\n\t}\n};\n\nexport default jsonError;\n", "\t\t\t\timport worker, * as OTHER_EXPORTS from \"/Users/cns/httpdocs/cddo/govreposcrape/src/index.ts\";\n\t\t\t\timport * as __MIDDLEWARE_0__ from \"/Users/cns/httpdocs/cddo/govreposcrape/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts\";\nimport * as __MIDDLEWARE_1__ from \"/Users/cns/httpdocs/cddo/govreposcrape/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts\";\n\n\t\t\t\texport * from \"/Users/cns/httpdocs/cddo/govreposcrape/src/index.ts\";\n\t\t\t\tconst MIDDLEWARE_TEST_INJECT = \"__INJECT_FOR_TESTING_WRANGLER_MIDDLEWARE__\";\n\t\t\t\texport const __INTERNAL_WRANGLER_MIDDLEWARE__ = [\n\t\t\t\t\t\n\t\t\t\t\t__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default\n\t\t\t\t]\n\t\t\t\texport default worker;", "export type Awaitable<T> = T | Promise<T>;\n// TODO: allow dispatching more events?\nexport type Dispatcher = (\n\ttype: \"scheduled\",\n\tinit: { cron?: string }\n) => Awaitable<void>;\n\nexport type IncomingRequest = Request<\n\tunknown,\n\tIncomingRequestCfProperties<unknown>\n>;\n\nexport interface MiddlewareContext {\n\tdispatch: Dispatcher;\n\tnext(request: IncomingRequest, env: any): Awaitable<Response>;\n}\n\nexport type Middleware = (\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tmiddlewareCtx: MiddlewareContext\n) => Awaitable<Response>;\n\nconst __facade_middleware__: Middleware[] = [];\n\n// The register functions allow for the insertion of one or many middleware,\n// We register internal middleware first in the stack, but have no way of controlling\n// the order that addMiddleware is run in service workers so need an internal function.\nexport function __facade_register__(...args: (Middleware | Middleware[])[]) {\n\t__facade_middleware__.push(...args.flat());\n}\nexport function __facade_registerInternal__(\n\t...args: (Middleware | Middleware[])[]\n) {\n\t__facade_middleware__.unshift(...args.flat());\n}\n\nfunction __facade_invokeChain__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tmiddlewareChain: Middleware[]\n): Awaitable<Response> {\n\tconst [head, ...tail] = middlewareChain;\n\tconst middlewareCtx: MiddlewareContext = {\n\t\tdispatch,\n\t\tnext(newRequest, newEnv) {\n\t\t\treturn __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);\n\t\t},\n\t};\n\treturn head(request, env, ctx, middlewareCtx);\n}\n\nexport function __facade_invoke__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tfinalMiddleware: Middleware\n): Awaitable<Response> {\n\treturn __facade_invokeChain__(request, env, ctx, dispatch, [\n\t\t...__facade_middleware__,\n\t\tfinalMiddleware,\n\t]);\n}\n", "// This loads all middlewares exposed on the middleware object and then starts\n// the invocation chain. The big idea is that we can add these to the middleware\n// export dynamically through wrangler, or we can potentially let users directly\n// add them as a sort of \"plugin\" system.\n\nimport ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from \"/Users/cns/httpdocs/cddo/govreposcrape/.wrangler/tmp/bundle-NTKv1p/middleware-insertion-facade.js\";\nimport { __facade_invoke__, __facade_register__, Dispatcher } from \"/Users/cns/httpdocs/cddo/govreposcrape/node_modules/wrangler/templates/middleware/common.ts\";\nimport type { WorkerEntrypointConstructor } from \"/Users/cns/httpdocs/cddo/govreposcrape/.wrangler/tmp/bundle-NTKv1p/middleware-insertion-facade.js\";\n\n// Preserve all the exports from the worker\nexport * from \"/Users/cns/httpdocs/cddo/govreposcrape/.wrangler/tmp/bundle-NTKv1p/middleware-insertion-facade.js\";\n\nclass __Facade_ScheduledController__ implements ScheduledController {\n\treadonly #noRetry: ScheduledController[\"noRetry\"];\n\n\tconstructor(\n\t\treadonly scheduledTime: number,\n\t\treadonly cron: string,\n\t\tnoRetry: ScheduledController[\"noRetry\"]\n\t) {\n\t\tthis.#noRetry = noRetry;\n\t}\n\n\tnoRetry() {\n\t\tif (!(this instanceof __Facade_ScheduledController__)) {\n\t\t\tthrow new TypeError(\"Illegal invocation\");\n\t\t}\n\t\t// Need to call native method immediately in case uncaught error thrown\n\t\tthis.#noRetry();\n\t}\n}\n\nfunction wrapExportedHandler(worker: ExportedHandler): ExportedHandler {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn worker;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\tconst fetchDispatcher: ExportedHandlerFetchHandler = function (\n\t\trequest,\n\t\tenv,\n\t\tctx\n\t) {\n\t\tif (worker.fetch === undefined) {\n\t\t\tthrow new Error(\"Handler does not export a fetch() function.\");\n\t\t}\n\t\treturn worker.fetch(request, env, ctx);\n\t};\n\n\treturn {\n\t\t...worker,\n\t\tfetch(request, env, ctx) {\n\t\t\tconst dispatcher: Dispatcher = function (type, init) {\n\t\t\t\tif (type === \"scheduled\" && worker.scheduled !== undefined) {\n\t\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\t\tDate.now(),\n\t\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t\t() => {}\n\t\t\t\t\t);\n\t\t\t\t\treturn worker.scheduled(controller, env, ctx);\n\t\t\t\t}\n\t\t\t};\n\t\t\treturn __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);\n\t\t},\n\t};\n}\n\nfunction wrapWorkerEntrypoint(\n\tklass: WorkerEntrypointConstructor\n): WorkerEntrypointConstructor {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn klass;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\t// `extend`ing `klass` here so other RPC methods remain callable\n\treturn class extends klass {\n\t\t#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (\n\t\t\trequest,\n\t\t\tenv,\n\t\t\tctx\n\t\t) => {\n\t\t\tthis.env = env;\n\t\t\tthis.ctx = ctx;\n\t\t\tif (super.fetch === undefined) {\n\t\t\t\tthrow new Error(\"Entrypoint class does not define a fetch() function.\");\n\t\t\t}\n\t\t\treturn super.fetch(request);\n\t\t};\n\n\t\t#dispatcher: Dispatcher = (type, init) => {\n\t\t\tif (type === \"scheduled\" && super.scheduled !== undefined) {\n\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\tDate.now(),\n\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t() => {}\n\t\t\t\t);\n\t\t\t\treturn super.scheduled(controller);\n\t\t\t}\n\t\t};\n\n\t\tfetch(request: Request<unknown, IncomingRequestCfProperties>) {\n\t\t\treturn __facade_invoke__(\n\t\t\t\trequest,\n\t\t\t\tthis.env,\n\t\t\t\tthis.ctx,\n\t\t\t\tthis.#dispatcher,\n\t\t\t\tthis.#fetchDispatcher\n\t\t\t);\n\t\t}\n\t};\n}\n\nlet WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;\nif (typeof ENTRY === \"object\") {\n\tWRAPPED_ENTRY = wrapExportedHandler(ENTRY);\n} else if (typeof ENTRY === \"function\") {\n\tWRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);\n}\nexport default WRAPPED_ENTRY;\n"],
  "mappings": "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",
  "names": ["logger", "logger", "logger", "sleep", "withRetry", "logger", "logger", "duration", "logger", "logger", "logger", "logger"]
}
